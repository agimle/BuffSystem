# BuffSystem æ¨èä¼˜åŒ–æµç¨‹ v4.0

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v4.0  
**æ›´æ–°æ—¥æœŸï¼š** 2026-02-11  
**é€‚ç”¨èŒƒå›´ï¼š** BuffSystem v4.x ç‰ˆæœ¬ä¼˜åŒ–  
**å‰ç½®æ¡ä»¶ï¼š** å·²å®Œæˆv1.0-v3.0æ‰€æœ‰ä¼˜åŒ–é¡¹

---

## ç›®å½•

1. [ä¼˜åŒ–æ€»è§ˆ](#ä¼˜åŒ–æ€»è§ˆ)
2. [Phase 1: æ€§èƒ½æ·±åº¦ä¼˜åŒ–](#phase-1-æ€§èƒ½æ·±åº¦ä¼˜åŒ–)
3. [Phase 2: åŠŸèƒ½æ‰©å±•](#phase-2-åŠŸèƒ½æ‰©å±•)
4. [Phase 3: å·¥å…·ä¸æ–‡æ¡£](#phase-3-å·¥å…·ä¸æ–‡æ¡£)
5. [Phase 4: é«˜çº§ç‰¹æ€§](#phase-4-é«˜çº§ç‰¹æ€§)
6. [ä¼˜åŒ–å®æ–½æ£€æŸ¥æ¸…å•](#ä¼˜åŒ–å®æ–½æ£€æŸ¥æ¸…å•)
7. [ç‰ˆæœ¬å‘å¸ƒè®¡åˆ’](#ç‰ˆæœ¬å‘å¸ƒè®¡åˆ’)

---

## ä¼˜åŒ–æ€»è§ˆ

### ä¼˜åŒ–ç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BuffSystem v4.0 ä¼˜åŒ–ç›®æ ‡                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ€§èƒ½ç›®æ ‡ï¼šæ”¯æŒ2000+ BuffåŒæ—¶è¿è¡Œï¼Œå¸§ç‡å½±å“<0.5ms           â”‚
â”‚  åŠŸèƒ½ç›®æ ‡ï¼šè¦†ç›–98%æ¸¸æˆç±»å‹çš„Bufféœ€æ±‚                         â”‚
â”‚  æ˜“ç”¨ç›®æ ‡ï¼šæ–°ç”¨æˆ·15åˆ†é’Ÿå†…ä¸Šæ‰‹ï¼Œæä¾›å®Œæ•´ç¤ºä¾‹é¡¹ç›®            â”‚
â”‚  ç¨³å®šç›®æ ‡ï¼šç”Ÿäº§ç¯å¢ƒé›¶å´©æºƒï¼Œå†…å­˜é›¶æ³„æ¼ï¼Œ100%å•å…ƒæµ‹è¯•è¦†ç›–     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸v3.0ä¼˜åŒ–æµç¨‹å¯¹æ¯”

| ä¼˜åŒ–é¡¹ | v3.0çŠ¶æ€ | v4.0çŠ¶æ€ | è¯´æ˜ |
|--------|---------|---------|------|
| ä¼˜åŒ–GetBuffsByTag | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 1 |
| å®Œå–„ç­–ç•¥æ¨¡å¼ | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 1 |
| ä»£ç ç²¾ç®€ | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 1 |
| å†…ç½®Effectåº“ | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 2 |
| å­˜æ¡£ç‰ˆæœ¬ç®¡ç† | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 2 |
| å®Œæ•´ç¤ºä¾‹é¡¹ç›® | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 2 |
| å¯è§†åŒ–è°ƒè¯•çª—å£ | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 3 |
| æ€§èƒ½ç›‘æ§å™¨ | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 3 |
| æ–‡æ¡£å®Œå–„ | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 3 |
| ç½‘ç»œåŒæ­¥æ”¯æŒ | â¬œ å¾…å®Œæˆ | ğŸ”µ ä¿ç•™ | çº³å…¥Phase 4 |
| Buffç»„åˆ/è¿æº | â¬œ å¾…å®Œæˆ | âœ… å·²å®Œæˆ | v3.0å·²å®ç° |
| **æ–°å¢ï¼šBuffå…ç–«ç³»ç»Ÿ** | - | ğŸŸ¢ æ–°å¢ | çº³å…¥Phase 2 |
| **æ–°å¢ï¼šBuffåŒºåŸŸç³»ç»Ÿ** | - | ğŸŸ¢ æ–°å¢ | çº³å…¥Phase 2 |
| **æ–°å¢ï¼šBuffDatabaseæ— é”åŒ–** | - | ğŸŸ¢ æ–°å¢ | çº³å…¥Phase 1 |

### ä¼˜åŒ–è·¯çº¿å›¾

```
æ—¶é—´çº¿ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

Phase 1 (3-5å¤©)    Phase 2 (1-2å‘¨)    Phase 3 (1å‘¨)      Phase 4 (2å‘¨)
   æ€§èƒ½æ·±åº¦ä¼˜åŒ–        åŠŸèƒ½æ‰©å±•            å·¥å…·ä¸æ–‡æ¡£          é«˜çº§ç‰¹æ€§
     â–¼                  â–¼                 â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Database â”‚        â”‚å†…ç½®Effectâ”‚        â”‚è°ƒè¯•çª—å£ â”‚      â”‚ç½‘ç»œåŒæ­¥ â”‚
â”‚æ— é”åŒ–   â”‚   â†’    â”‚å…ç–«ç³»ç»Ÿ â”‚   â†’    â”‚æ€§èƒ½ç›‘æ§ â”‚  â†’   â”‚å¿«ç…§ç³»ç»Ÿ â”‚
â”‚æŸ¥è¯¢ä¼˜åŒ– â”‚        â”‚åŒºåŸŸç³»ç»Ÿ â”‚        â”‚æ–‡æ¡£å®Œå–„ â”‚      â”‚AIæ”¯æŒ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 1: æ€§èƒ½æ·±åº¦ä¼˜åŒ–

### ğŸ”µ 1.1 BuffDatabaseæ— é”åŒ–

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜  
**é¢„ä¼°å·¥æ—¶ï¼š** 1-2å¤©  
**å½±å“èŒƒå›´ï¼š** `BuffDatabase`  
**çŠ¶æ€ï¼š** ğŸŸ¢ æ–°å¢ï¼ˆv4.0ï¼‰

#### å½“å‰é—®é¢˜

```csharp
// å½“å‰å®ç° - æ¯æ¬¡è®¿é—®éƒ½lock
public IBuffData GetBuffData(int id)
{
    lock (dataLock)  // é«˜é¢‘è°ƒç”¨æ—¶çš„æ€§èƒ½ç“¶é¢ˆ
    {
        idToData.TryGetValue(id, out var data);
        return data;
    }
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```csharp
public class BuffDatabase
{
    private static readonly BuffDatabase instance = new();
    public static BuffDatabase Instance => instance;

    private Dictionary<int, IBuffData> idToData = new();
    private Dictionary<string, int> nameToId = new();
    private IReadOnlyDictionary<int, IBuffData> readonlyData;
    private bool isInitialized;

    private BuffDatabase() { }

    public void Initialize()
    {
        if (isInitialized) return;

        LoadAllBuffData();
        
        // æ„å»ºå®Œæˆåè½¬ä¸ºåªè¯»ï¼Œåç»­æ— éœ€lock
        readonlyData = new System.Collections.ObjectModel.ReadOnlyDictionary<int, IBuffData>(idToData);
        isInitialized = true;

        Debug.Log($"[BuffDatabase] åˆå§‹åŒ–å®Œæˆï¼ŒåŠ è½½äº† {idToData.Count} ä¸ªBuffé…ç½®");
    }

    public IBuffData GetBuffData(int id)
    {
        // æ— éœ€lockï¼Œçº¿ç¨‹å®‰å…¨
        readonlyData?.TryGetValue(id, out var data);
        return data;
    }

    public IBuffData GetBuffData(string name)
    {
        if (nameToId.TryGetValue(name, out int id))
        {
            return GetBuffData(id);
        }
        return null;
    }

    public void Reload()
    {
        // Reloadæ—¶åˆ›å»ºæ–°å­—å…¸ï¼Œæ›¿æ¢å¼•ç”¨
        var newData = new Dictionary<int, IBuffData>();
        var newNameToId = new Dictionary<string, int>();
        
        // åŠ è½½æ•°æ®åˆ°æ–°å­—å…¸...
        
        // åŸå­æ€§æ›¿æ¢
        idToData = newData;
        nameToId = newNameToId;
        readonlyData = new System.Collections.ObjectModel.ReadOnlyDictionary<int, IBuffData>(idToData);
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] BuffDatabaseè¯»å–æ“ä½œæ— éœ€lock
- [ ] å¹¶å‘è¯»å–æ€§èƒ½æå‡50%+
- [ ] Reloadæ“ä½œçº¿ç¨‹å®‰å…¨
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ç‡100%

---

### ğŸ”µ 1.2 ä¼˜åŒ–GetBuffsByTagå®ç°

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 1å¤©  
**å½±å“èŒƒå›´ï¼š** `BuffApi`, `BuffContainer`  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### å½“å‰é—®é¢˜

```csharp
// å½“å‰å®ç° - æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºList
public static IEnumerable<IBuff> GetBuffsByTag(string tag, IBuffOwner target)
{
    var result = new List<IBuff>(); // GC Alloc!
    foreach (var buff in target.BuffContainer.AllBuffs)
    {
        if (buff.Data.HasTag(tag))
        {
            result.Add(buff);
        }
    }
    return result;
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```csharp
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨yield returné¿å…åˆ†é…
public static IEnumerable<IBuff> GetBuffsByTag(string tag, IBuffOwner target)
{
    if (target?.BuffContainer == null || string.IsNullOrEmpty(tag))
    {
        yield break;
    }

    foreach (var buff in target.BuffContainer.AllBuffs)
    {
        if (buff.Data.HasTag(tag))
        {
            yield return buff;
        }
    }
}

// æ–¹æ¡ˆ2ï¼šå¦‚æœéœ€è¦Listï¼ˆå¦‚éœ€è¦å¤šæ¬¡éå†ï¼‰ï¼Œæä¾›æ˜¾å¼æ–¹æ³•
public static void GetBuffsByTagNonAlloc(
    string tag, 
    IBuffOwner target, 
    List<IBuff> result)
{
    result.Clear();
    if (target?.BuffContainer == null || string.IsNullOrEmpty(tag))
    {
        return;
    }

    foreach (var buff in target.BuffContainer.AllBuffs)
    {
        if (buff.Data.HasTag(tag))
        {
            result.Add(buff);
        }
    }
}

// æ–¹æ¡ˆ3ï¼šç¼“å­˜æŸ¥è¯¢ç»“æœï¼ˆé€‚ç”¨äºæ ‡ç­¾æ•°é‡å°‘çš„æƒ…å†µï¼‰
public class BuffContainer
{
    private readonly Dictionary<string, List<IBuff>> buffsByTag = new();
    
    public IReadOnlyList<IBuff> GetBuffsByTag(string tag)
    {
        if (buffsByTag.TryGetValue(tag, out var list))
        {
            return list;
        }
        return System.Collections.ObjectModel.ReadOnlyCollection<IBuff>.Empty;
    }
    
    // åœ¨AddBuff/RemoveBuffæ—¶ç»´æŠ¤ç¼“å­˜
    private void UpdateTagCache(BuffEntity buff, bool isAdding)
    {
        foreach (var tag in buff.Data.Tags)
        {
            if (!buffsByTag.TryGetValue(tag, out var list))
            {
                list = new List<IBuff>();
                buffsByTag[tag] = list;
            }
            
            if (isAdding)
                list.Add(buff);
            else
                list.Remove(buff);
        }
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] GetBuffsByTagä¸å†äº§ç”ŸGC Alloc
- [ ] æä¾›NonAllocç‰ˆæœ¬ä¾›é«˜é¢‘è°ƒç”¨ä½¿ç”¨
- [ ] æ€§èƒ½æµ‹è¯•æ˜¾ç¤ºè°ƒç”¨è€—æ—¶å‡å°‘50%+

---

### ğŸ”µ 1.3 ä¼˜åŒ–BuffContainer.AllBuffsç¼“å­˜

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 1å¤©  
**å½±å“èŒƒå›´ï¼š** `BuffContainer`  
**çŠ¶æ€ï¼š** ğŸŸ¢ æ–°å¢ï¼ˆv4.0ï¼‰

#### å½“å‰é—®é¢˜

```csharp
// å½“å‰å®ç°
public IReadOnlyCollection<IBuff> AllBuffs
{
    get
    {
        if (!isAllBuffsCacheValid)
        {
            buffCache.Clear();  // æ¯æ¬¡é‡å»º
            foreach (var buff in buffByInstanceId.Values)
            {
                buffCache.Add(buff);
            }
            allBuffsReadOnly = buffCache.AsReadOnly();
            isAllBuffsCacheValid = true;
        }
        return allBuffsReadOnly;
    }
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```csharp
public class BuffContainer : IBuffContainer
{
    // ä½¿ç”¨åªè¯»åŒ…è£…å™¨é¿å…é‡å»º
    private readonly BuffCollection allBuffsWrapper;
    
    public BuffContainer(IBuffOwner owner)
    {
        // ...
        allBuffsWrapper = new BuffCollection(this);
    }
    
    public IReadOnlyCollection<IBuff> AllBuffs => allBuffsWrapper;
    
    // è‡ªå®šä¹‰åªè¯»é›†åˆï¼Œç›´æ¥åŒ…è£…å­—å…¸Values
    private class BuffCollection : IReadOnlyCollection<IBuff>
    {
        private readonly BuffContainer container;
        
        public BuffCollection(BuffContainer container)
        {
            this.container = container;
        }
        
        public int Count => container.buffByInstanceId.Count;
        
        public IEnumerator<IBuff> GetEnumerator()
        {
            foreach (var buff in container.buffByInstanceId.Values)
            {
                yield return buff;
            }
        }
        
        System.Collections.IEnumerator System.Collections.IEnumerable.GetEnumerator()
            => GetEnumerator();
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] AllBuffsè®¿é—®æ— éœ€é‡å»ºç¼“å­˜
- [ ] ç¼“å­˜å¤±æ•ˆé€»è¾‘ç®€åŒ–
- [ ] å†…å­˜å ç”¨é™ä½

---

### ğŸ”µ 1.4 å®Œå–„ç­–ç•¥æ¨¡å¼åº”ç”¨

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 2-3å¤©  
**å½±å“èŒƒå›´ï¼š** `BuffContainer`, `BuffStrategy`  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### å½“å‰é—®é¢˜

ç­–ç•¥ç±»å·²å®šä¹‰ä½†æœªåœ¨BuffContainerä¸­å®Œå…¨åº”ç”¨ï¼Œéƒ¨åˆ†é€»è¾‘ä»ä½¿ç”¨switchè¯­å¥ã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ

```csharp
// BuffContainer.cs é‡æ„
public class BuffContainer : IBuffContainer
{
    // ç­–ç•¥ç¼“å­˜
    private readonly Dictionary<BuffStackMode, IStackStrategy> stackStrategies;
    private readonly Dictionary<BuffRemoveMode, IRemoveStrategy> removeStrategies;
    
    public BuffContainer(IBuffOwner owner)
    {
        // ... ç°æœ‰ä»£ç 
        
        // åˆå§‹åŒ–ç­–ç•¥
        stackStrategies = new Dictionary<BuffStackMode, IStackStrategy>
        {
            [BuffStackMode.None] = new NonStackableStrategy(),
            [BuffStackMode.Stackable] = new StackableStrategy(),
            [BuffStackMode.Independent] = new IndependentStrategy()
        };
        
        removeStrategies = new Dictionary<BuffRemoveMode, IRemoveStrategy>
        {
            [BuffRemoveMode.Remove] = new DirectRemoveStrategy(),
            [BuffRemoveMode.Reduce] = new ReduceStackStrategy()
        };
    }
    
    private IBuff HandleExistingBuff(BuffEntity existingBuff, IBuffData data, object source)
    {
        // ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ›¿ä»£switch
        var strategy = stackStrategies[data.StackMode];
        bool shouldCreateNew = strategy.HandleStack(existingBuff, data);
        
        if (shouldCreateNew)
        {
            return CreateNewBuff(data, source);
        }
        
        // å¤„ç†åˆ·æ–°
        if (strategy.ShouldRefresh(data))
        {
            existingBuff.RefreshDuration();
        }
        
        return existingBuff;
    }
}

// å¢å¼ºç­–ç•¥æ¥å£
public interface IStackStrategy
{
    /// <summary>
    /// å¤„ç†å å±‚é€»è¾‘
    /// </summary>
    /// <param name="existingBuff">å·²å­˜åœ¨çš„Buff</param>
    /// <param name="newData">æ–°æ·»åŠ çš„Buffæ•°æ®</param>
    /// <returns>æ˜¯å¦åˆ›å»ºæ–°Buff</returns>
    bool HandleStack(IBuff existingBuff, IBuffData newData);
    
    /// <summary>
    /// æ˜¯å¦éœ€è¦åˆ·æ–°æŒç»­æ—¶é—´
    /// </summary>
    bool ShouldRefresh(IBuffData data);
}

// æ›´æ–°ç°æœ‰ç­–ç•¥å®ç°
public class NonStackableStrategy : IStackStrategy
{
    public bool HandleStack(IBuff existingBuff, IBuffData newData)
    {
        // ä¸å¯å åŠ ï¼Œä¸å¢åŠ å±‚æ•°
        return false;
    }
    
    public bool ShouldRefresh(IBuffData data) => data.CanRefresh;
}

public class StackableStrategy : IStackStrategy
{
    public bool HandleStack(IBuff existingBuff, IBuffData newData)
    {
        existingBuff.AddStack(newData.AddStackCount);
        return false;
    }
    
    public bool ShouldRefresh(IBuffData data) => false;
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] BuffContainerä¸­æ‰€æœ‰switché€»è¾‘ç­–ç•¥åŒ–
- [ ] ç­–ç•¥å¯é…ç½®ã€å¯æ‰©å±•
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡100%

---

### ğŸ”µ 1.5 ä»£ç ç²¾ç®€ä¸é‡æ„

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½  
**é¢„ä¼°å·¥æ—¶ï¼š** 1-2å¤©  
**å½±å“èŒƒå›´ï¼š** å…¨å±€  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### ä¼˜åŒ–é¡¹

```csharp
// 1. åˆå¹¶é‡å¤ä»£ç 
// å½“å‰ï¼šBuffApiå’ŒBuffOwneræœ‰é‡å¤çš„æ–¹æ³•
// ä¼˜åŒ–ï¼šBuffOwneræ–¹æ³•ç›´æ¥è°ƒç”¨BuffApi

// 2. æå–å…¬å…±é€»è¾‘åˆ°BuffQueryHelper
public static class BuffQueryHelper
{
    public static bool HasTag(this IBuffData data, string tag)
    {
        if (data?.Tags == null || string.IsNullOrEmpty(tag))
            return false;
            
        for (int i = 0; i < data.Tags.Count; i++)
        {
            if (data.Tags[i] == tag)
                return true;
        }
        return false;
    }
    
    public static IEnumerable<IBuff> FilterByTag(this IEnumerable<IBuff> buffs, string tag)
    {
        foreach (var buff in buffs)
        {
            if (buff.Data.HasTag(tag))
                yield return buff;
        }
    }
    
    // æ£€æŸ¥æ‰€æœ‰æ¡ä»¶
    public static bool CheckAllConditions(
        this IEnumerable<IBuffCondition> conditions, 
        IBuffOwner owner, 
        IBuffData data)
    {
        foreach (var condition in conditions)
        {
            if (condition != null && !condition.Check(owner, data))
                return false;
        }
        return true;
    }
}

// 3. ç»Ÿä¸€å­—æ®µå‘½å
// å°†æ‰€æœ‰ç§æœ‰å­—æ®µç»Ÿä¸€ä¸º _camelCase æ ¼å¼
// ä½¿ç”¨Rideré‡æ„å·¥å…·æ‰¹é‡å¤„ç†
```

#### éªŒæ”¶æ ‡å‡†

- [ ] æ¶ˆé™¤é‡å¤ä»£ç 
- [ ] ç»Ÿä¸€å‘½åè§„èŒƒ
- [ ] ä»£ç è¡Œæ•°å‡å°‘10%+

---

## Phase 2: åŠŸèƒ½æ‰©å±•

### ğŸ”µ 2.1 å†…ç½®Effectåº“

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 3-5å¤©  
**å½±å“èŒƒå›´ï¼š** æ–°å¢`Effects`æ–‡ä»¶å¤¹  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### è®¾è®¡ç›®æ ‡

æä¾›å¸¸ç”¨çš„Effecté¢„è®¾ï¼Œå‡å°‘ç”¨æˆ·é‡å¤å¼€å‘ã€‚

#### å®ç°æ–¹æ¡ˆ

```csharp
// Effects/ModifyAttributeEffect.cs
[Serializable]
public class ModifyAttributeEffect : EffectBase
{
    [SerializeField] private string attributeName;
    [SerializeField] private float modifyValue;
    [SerializeField] private ModifyType modifyType = ModifyType.Add;
    [SerializeField] private bool scaleWithStack = true;
    
    private float appliedValue;
    
    public override void Execute(IBuff buff)
    {
        if (buff.Owner is IAttributeOwner attrOwner)
        {
            appliedValue = CalculateValue(buff);
            attrOwner.ModifyAttribute(attributeName, appliedValue, modifyType);
        }
    }
    
    public override void Cancel(IBuff buff)
    {
        if (buff.Owner is IAttributeOwner attrOwner)
        {
            attrOwner.ModifyAttribute(attributeName, -appliedValue, modifyType);
        }
    }
    
    private float CalculateValue(IBuff buff)
    {
        float value = modifyValue;
        if (scaleWithStack)
        {
            value *= buff.CurrentStack;
        }
        return value;
    }
}

public enum ModifyType
{
    Add,      // åŠ æ³•
    Multiply, // ä¹˜æ³•
    Set       // è®¾ç½®
}

// Effects/DamageOverTimeEffect.cs
[Serializable]
public class DamageOverTimeEffect : EffectBase, IBuffLogicUpdate
{
    [SerializeField] private float damagePerSecond;
    [SerializeField] private DamageType damageType = DamageType.Magic;
    [SerializeField] private bool ignoreDefense;
    
    private float damageAccumulator;
    
    public void OnLogicUpdate(float deltaTime)
    {
        damageAccumulator += damagePerSecond * deltaTime * Buff.CurrentStack;
        
        if (damageAccumulator >= 1f)
        {
            int damage = Mathf.FloorToInt(damageAccumulator);
            damageAccumulator -= damage;
            
            if (Owner is IDamageable damageable)
            {
                var damageInfo = new DamageInfo(damage, damageType, Source, ignoreDefense);
                damageable.TakeDamage(damageInfo);
            }
        }
    }
}

// Effects/HealOverTimeEffect.cs
[Serializable]
public class HealOverTimeEffect : EffectBase, IBuffLogicUpdate
{
    [SerializeField] private float healPerSecond;
    [SerializeField] private bool isPercent;
    [SerializeField] private float percentOfMaxHealth;
    
    private float healAccumulator;
    
    public void OnLogicUpdate(float deltaTime)
    {
        float heal = healPerSecond * deltaTime * Buff.CurrentStack;
        
        if (isPercent && Owner is IAttributeOwner attrOwner)
        {
            heal += attrOwner.GetMaxHealth() * percentOfMaxHealth * deltaTime * Buff.CurrentStack;
        }
        
        healAccumulator += heal;
        
        if (healAccumulator >= 1f)
        {
            int healAmount = Mathf.FloorToInt(healAccumulator);
            healAccumulator -= healAmount;
            
            if (Owner is IHealable healable)
            {
                healable.Heal(healAmount, Source);
            }
        }
    }
}

// Effects/PeriodicTriggerEffect.cs
[Serializable]
public class PeriodicTriggerEffect : EffectBase, IBuffLogicUpdate
{
    [SerializeField] private float interval = 1f;
    [SerializeField] private string triggerEvent = "PeriodicTrigger";
    [SerializeField] private bool triggerOnAdd = false;
    
    private float timer;
    
    public override void Execute(IBuff buff)
    {
        if (triggerOnAdd)
        {
            Trigger(buff);
        }
    }
    
    public void OnLogicUpdate(float deltaTime)
    {
        timer += deltaTime;
        
        if (timer >= interval)
        {
            timer -= interval;
            Trigger(Buff);
        }
    }
    
    private void Trigger(IBuff buff)
    {
        SendEvent(buff, triggerEvent, new PeriodicTriggerData 
        { 
            Stack = buff.CurrentStack,
            Interval = interval 
        });
    }
}

// Effects/SpawnPrefabEffect.cs
[Serializable]
public class SpawnPrefabEffect : EffectBase
{
    [SerializeField] private GameObject prefab;
    [SerializeField] private Vector3 offset;
    [SerializeField] private bool attachToOwner = true;
    [SerializeField] private float destroyAfter = -1f; // -1è¡¨ç¤ºä¸è‡ªåŠ¨é”€æ¯
    
    private GameObject spawnedInstance;
    
    public override void Execute(IBuff buff)
    {
        if (prefab == null) return;
        
        Vector3 spawnPosition = buff.Owner is MonoBehaviour mono 
            ? mono.transform.position + offset 
            : offset;
            
        spawnedInstance = Object.Instantiate(prefab, spawnPosition, Quaternion.identity);
        
        if (attachToOwner && buff.Owner is MonoBehaviour ownerMono)
        {
            spawnedInstance.transform.SetParent(ownerMono.transform);
        }
        
        if (destroyAfter > 0)
        {
            Object.Destroy(spawnedInstance, destroyAfter);
        }
    }
    
    public override void Cancel(IBuff buff)
    {
        if (spawnedInstance != null && destroyAfter <= 0)
        {
            Object.Destroy(spawnedInstance);
        }
    }
}
```

#### å†…ç½®Effectæ¸…å•

| Effectç±» | åŠŸèƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| ModifyAttributeEffect | ä¿®æ”¹å±æ€§å€¼ | å¢ç›Š/å‡ç›Šæ•ˆæœ |
| DamageOverTimeEffect | æŒç»­ä¼¤å®³ | ä¸­æ¯’ã€ç‡ƒçƒ§ |
| HealOverTimeEffect | æŒç»­æ²»ç–— | å›è¡€ã€å†ç”Ÿ |
| PeriodicTriggerEffect | å‘¨æœŸæ€§è§¦å‘ | è§¦å‘æŠ€èƒ½ã€ç‰¹æ•ˆ |
| SpawnPrefabEffect | ç”Ÿæˆé¢„åˆ¶ä½“ | ç‰¹æ•ˆã€å¬å”¤ç‰© |
| ModifySpeedEffect | ä¿®æ”¹é€Ÿåº¦ | åŠ é€Ÿã€å‡é€Ÿ |
| StunEffect | çœ©æ™•æ•ˆæœ | æ§åˆ¶æ•ˆæœ |
| ShieldEffect | æŠ¤ç›¾æ•ˆæœ | å¸æ”¶ä¼¤å®³ |

#### éªŒæ”¶æ ‡å‡†

- [ ] æä¾›è‡³å°‘8ç§å¸¸ç”¨Effect
- [ ] æ¯ç§Effectæœ‰å®Œæ•´XMLæ³¨é‡Š
- [ ] æä¾›Effectä½¿ç”¨ç¤ºä¾‹
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡80%+

---

### ğŸŸ¢ 2.2 Buffå…ç–«ç³»ç»Ÿ

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 2-3å¤©  
**å½±å“èŒƒå›´ï¼š** `IBuffOwner`, `BuffContainer`  
**çŠ¶æ€ï¼š** ğŸŸ¢ æ–°å¢ï¼ˆv4.0ï¼‰

#### è®¾è®¡ç›®æ ‡

æŸäº›å•ä½å¯¹ç‰¹å®šBuffå…ç–«ï¼Œæ— æ³•è¢«æ·»åŠ æˆ–è‡ªåŠ¨ç§»é™¤ã€‚

#### å®ç°æ–¹æ¡ˆ

```csharp
// Core/IBuffOwner.cs æ‰©å±•
public interface IBuffOwner
{
    // ... ç°æœ‰ä»£ç 
    
    /// <summary>
    /// æ£€æŸ¥æ˜¯å¦å¯¹æŒ‡å®šBuffå…ç–«
    /// </summary>
    bool IsImmuneTo(int buffId);
    
    /// <summary>
    /// æ£€æŸ¥æ˜¯å¦å¯¹æŒ‡å®šæ ‡ç­¾å…ç–«
    /// </summary>
    bool IsImmuneToTag(string tag);
    
    /// <summary>
    /// è·å–å…ç–«æ ‡ç­¾åˆ—è¡¨
    /// </summary>
    IReadOnlyList<string> ImmuneTags { get; }
}

// Runtime/BuffOwner.cs å®ç°
public class BuffOwner : MonoBehaviour, IBuffOwner
{
    [SerializeField] private List<int> immuneBuffIds = new();
    [SerializeField] private List<string> immuneTags = new();
    
    private HashSet<int> immuneBuffIdSet;
    private HashSet<string> immuneTagSet;
    
    public IReadOnlyList<string> ImmuneTags => immuneTags;
    
    private void Awake()
    {
        // åˆå§‹åŒ–HashSetæé«˜æŸ¥è¯¢æ€§èƒ½
        immuneBuffIdSet = new HashSet<int>(immuneBuffIds);
        immuneTagSet = new HashSet<string>(immuneTags);
    }
    
    public bool IsImmuneTo(int buffId)
    {
        return immuneBuffIdSet.Contains(buffId);
    }
    
    public bool IsImmuneToTag(string tag)
    {
        return immuneTagSet.Contains(tag);
    }
    
    // è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ /ç§»é™¤å…ç–«
    public void AddImmunity(int buffId)
    {
        if (immuneBuffIdSet.Add(buffId))
        {
            immuneBuffIds.Add(buffId);
            // ç§»é™¤å·²å­˜åœ¨çš„Buff
            BuffContainer.RemoveBuff(buffId);
        }
    }
    
    public void RemoveImmunity(int buffId)
    {
        if (immuneBuffIdSet.Remove(buffId))
        {
            immuneBuffIds.Remove(buffId);
        }
    }
    
    public void AddImmunityTag(string tag)
    {
        if (immuneTagSet.Add(tag))
        {
            immuneTags.Add(tag);
            // ç§»é™¤å·²å­˜åœ¨çš„Buff
            BuffContainer.RemoveBuffsByTag(tag);
        }
    }
}

// Runtime/BuffContainer.cs ä¿®æ”¹
public IBuff AddBuff(IBuffData data, object source = null)
{
    // æ–°å¢ï¼šå…ç–«æ£€æŸ¥
    if (Owner.IsImmuneTo(data.Id))
    {
        if (BuffSystemConfig.Instance.EnableDebugLog)
        {
            Debug.Log($"[BuffContainer] {Owner.OwnerName} å…ç–«Buff {data.Name}({data.Id})");
        }
        return null;
    }
    
    // æ£€æŸ¥æ ‡ç­¾å…ç–«
    foreach (var tag in data.Tags)
    {
        if (Owner.IsImmuneToTag(tag))
        {
            if (BuffSystemConfig.Instance.EnableDebugLog)
            {
                Debug.Log($"[BuffContainer] {Owner.OwnerName} å…ç–«æ ‡ç­¾ {tag} çš„Buff {data.Name}");
            }
            return null;
        }
    }
    
    // ... åŸæœ‰é€»è¾‘
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] æ”¯æŒBuff IDå…ç–«
- [ ] æ”¯æŒæ ‡ç­¾å…ç–«
- [ ] è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ /ç§»é™¤å…ç–«
- [ ] å…ç–«æ—¶è‡ªåŠ¨ç§»é™¤å·²å­˜åœ¨çš„Buff

---

### ğŸŸ¢ 2.3 BuffåŒºåŸŸç³»ç»Ÿ

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 3-4å¤©  
**å½±å“èŒƒå›´ï¼š** æ–°å¢`BuffArea`æ–‡ä»¶å¤¹  
**çŠ¶æ€ï¼š** ğŸŸ¢ æ–°å¢ï¼ˆv4.0ï¼‰

#### è®¾è®¡ç›®æ ‡

å®ç°æŒç»­æ€§AOEå…‰ç¯æ•ˆæœï¼Œè¿›å…¥åŒºåŸŸçš„å•ä½è‡ªåŠ¨è·å¾—Buffï¼Œç¦»å¼€åˆ™ç§»é™¤ã€‚

#### å®ç°æ–¹æ¡ˆ

```csharp
// Runtime/BuffArea.cs
public class BuffArea : MonoBehaviour
{
    [Header("Buffé…ç½®")]
    [SerializeField] private int buffId;
    [SerializeField] private float applyInterval = 1f; // é‡æ–°åº”ç”¨é—´éš”
    
    [Header("åŒºåŸŸè®¾ç½®")]
    [SerializeField] private float radius = 5f;
    [SerializeField] private LayerMask targetLayers = ~0;
    [SerializeField] private bool use2DPhysics = false;
    
    [Header("è¡Œä¸ºè®¾ç½®")]
    [SerializeField] private bool removeOnExit = true;
    [SerializeField] private float exitGracePeriod = 0.5f; // ç¦»å¼€åçš„å®½é™æœŸ
    
    private readonly Dictionary<IBuffOwner, BuffAreaEntry> entries = new();
    private float timer;
    
    private class BuffAreaEntry
    {
        public IBuffOwner Owner;
        public IBuff AppliedBuff;
        public float LastSeenTime;
        public bool IsInside;
    }
    
    private void Update()
    {
        timer += Time.deltaTime;
        
        if (timer >= applyInterval)
        {
            timer -= applyInterval;
            UpdateArea();
        }
        
        // æ¸…ç†ç¦»å¼€å®½é™æœŸè¿‡æœŸçš„æ¡ç›®
        CleanupExpiredEntries();
    }
    
    private void UpdateArea()
    {
        // æ£€æµ‹èŒƒå›´å†…ç›®æ ‡
        if (use2DPhysics)
        {
            UpdateArea2D();
        }
        else
        {
            UpdateArea3D();
        }
    }
    
    private void UpdateArea3D()
    {
        var colliders = Physics.OverlapSphere(transform.position, radius, targetLayers);
        var currentOwners = new HashSet<IBuffOwner>();
        
        foreach (var col in colliders)
        {
            if (col.TryGetComponent<IBuffOwner>(out var owner))
            {
                currentOwners.Add(owner);
                ProcessEntry(owner);
            }
        }
        
        // æ ‡è®°ä¸åœ¨èŒƒå›´å†…çš„æ¡ç›®
        foreach (var entry in entries.Values)
        {
            if (!currentOwners.Contains(entry.Owner))
            {
                entry.IsInside = false;
            }
        }
    }
    
    private void ProcessEntry(IBuffOwner owner)
    {
        if (!entries.TryGetValue(owner, out var entry))
        {
            // æ–°è¿›å…¥çš„å•ä½
            entry = new BuffAreaEntry
            {
                Owner = owner,
                IsInside = true,
                LastSeenTime = Time.time
            };
            entries[owner] = entry;
            
            // æ·»åŠ Buff
            entry.AppliedBuff = owner.BuffContainer?.AddBuff(
                BuffDatabase.Instance.GetBuffData(buffId), 
                this);
            
            OnOwnerEnter(owner);
        }
        else
        {
            // æ›´æ–°å·²å­˜åœ¨çš„æ¡ç›®
            entry.IsInside = true;
            entry.LastSeenTime = Time.time;
            
            // å¦‚æœBuffå·²è¿‡æœŸï¼Œé‡æ–°æ·»åŠ 
            if (entry.AppliedBuff == null || entry.AppliedBuff.IsMarkedForRemoval)
            {
                entry.AppliedBuff = owner.BuffContainer?.AddBuff(
                    BuffDatabase.Instance.GetBuffData(buffId), 
                    this);
            }
        }
    }
    
    private void CleanupExpiredEntries()
    {
        var expiredOwners = new List<IBuffOwner>();
        
        foreach (var kvp in entries)
        {
            if (!kvp.Value.IsInside && Time.time - kvp.Value.LastSeenTime > exitGracePeriod)
            {
                expiredOwners.Add(kvp.Key);
            }
        }
        
        foreach (var owner in expiredOwners)
        {
            if (entries.TryGetValue(owner, out var entry))
            {
                if (removeOnExit && entry.AppliedBuff != null)
                {
                    owner.BuffContainer?.RemoveBuff(entry.AppliedBuff);
                }
                
                OnOwnerExit(owner);
                entries.Remove(owner);
            }
        }
    }
    
    protected virtual void OnOwnerEnter(IBuffOwner owner) { }
    protected virtual void OnOwnerExit(IBuffOwner owner) { }
    
    private void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.cyan;
        Gizmos.DrawWireSphere(transform.position, radius);
    }
}

// å˜ä½“ï¼šæŒç»­ä¼¤å®³åŒºåŸŸ
public class DamageArea : BuffArea
{
    [SerializeField] private float damagePerSecond;
    [SerializeField] private DamageType damageType;
    
    protected override void OnOwnerEnter(IBuffOwner owner)
    {
        // å¯ä»¥ç«‹å³é€ æˆä¸€æ¬¡ä¼¤å®³
        if (owner is IDamageable damageable)
        {
            damageable.TakeDamage(Mathf.RoundToInt(damagePerSecond), damageType, this);
        }
    }
}

// å˜ä½“ï¼šæ²»ç–—åŒºåŸŸ
public class HealArea : BuffArea
{
    [SerializeField] private float healPerSecond;
    
    protected override void OnOwnerEnter(IBuffOwner owner)
    {
        if (owner is IHealable healable)
        {
            healable.Heal(Mathf.RoundToInt(healPerSecond), this);
        }
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] æ”¯æŒ3D/2Dç‰©ç†æ£€æµ‹
- [ ] æ”¯æŒè¿›å…¥/ç¦»å¼€å›è°ƒ
- [ ] æ”¯æŒç¦»å¼€å®½é™æœŸ
- [ ] å¯è§†åŒ–åŒºåŸŸèŒƒå›´

---

### ğŸ”µ 2.4 å­˜æ¡£ç‰ˆæœ¬ç®¡ç†

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 2-3å¤©  
**å½±å“èŒƒå›´ï¼š** `BuffSaveManager`, `IBuffSerializable`  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### è®¾è®¡ç›®æ ‡

æ”¯æŒå­˜æ¡£ç‰ˆæœ¬å…¼å®¹ï¼Œå‡çº§åèƒ½å¤Ÿæ­£ç¡®è¯»å–æ—§ç‰ˆæœ¬å­˜æ¡£ã€‚

#### å®ç°æ–¹æ¡ˆ

```csharp
// Core/IBuffSerializable.cs æ‰©å±•
public class BuffSaveData
{
    public int Version = 1; // å­˜æ¡£ç‰ˆæœ¬å·
    public int BuffId;
    public int CurrentStack;
    public float ElapsedDuration;
    public int SourceId;
    public Dictionary<string, string> CustomData;
    
    // ç‰ˆæœ¬è¿ç§»æ–¹æ³•
    public void MigrateToLatest()
    {
        while (Version < CurrentVersion)
        {
            MigrateFrom(Version);
            Version++;
        }
    }
    
    private void MigrateFrom(int fromVersion)
    {
        switch (fromVersion)
        {
            case 1:
                // v1 -> v2 è¿ç§»é€»è¾‘
                // ä¾‹å¦‚ï¼šé‡å‘½åå­—æ®µ
                if (CustomData.TryGetValue("oldField", out var value))
                {
                    CustomData["newField"] = value;
                    CustomData.Remove("oldField");
                }
                break;
        }
    }
    
    public const int CurrentVersion = 2;
}

// Runtime/BuffSaveManager.cs ä¿®æ”¹
public static List<BuffOwnerSaveData> SaveAll()
{
    var result = new List<BuffOwnerSaveData>();
    
    foreach (var owner in BuffOwner.AllOwners)
    {
        if (owner != null)
        {
            var ownerSaveData = SaveOwner(owner);
            if (ownerSaveData.Buffs.Count > 0)
            {
                // è®¾ç½®ç³»ç»Ÿç‰ˆæœ¬
                ownerSaveData.SystemVersion = BuffSaveData.CurrentVersion;
                result.Add(ownerSaveData);
            }
        }
    }
    
    return result;
}

public static void LoadAll(List<BuffOwnerSaveData> saveDataList)
{
    foreach (var ownerSaveData in saveDataList)
    {
        // æ‰¾åˆ°å¯¹åº”çš„Owner
        var owner = FindOwnerById(ownerSaveData.OwnerId);
        if (owner != null)
        {
            LoadOwner(owner, ownerSaveData);
        }
    }
}

public static void LoadOwner(IBuffOwner owner, BuffOwnerSaveData saveData)
{
    // ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
    if (saveData.SystemVersion > BuffSaveData.CurrentVersion)
    {
        Debug.LogError($"[BuffSaveManager] å­˜æ¡£ç‰ˆæœ¬ {saveData.SystemVersion} é«˜äºå½“å‰ç³»ç»Ÿç‰ˆæœ¬ {BuffSaveData.CurrentVersion}");
        return;
    }
    
    foreach (var buffSaveData in saveData.Buffs)
    {
        // ç‰ˆæœ¬è¿ç§»
        buffSaveData.MigrateToLatest();
        
        // åŠ è½½Buff...
        LoadBuff(owner, buffSaveData);
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] å­˜æ¡£åŒ…å«ç‰ˆæœ¬å·
- [ ] æ”¯æŒç‰ˆæœ¬è‡ªåŠ¨è¿ç§»
- [ ] é«˜ç‰ˆæœ¬å­˜æ¡£åœ¨ä½ç‰ˆæœ¬ç³»ç»Ÿæç¤ºé”™è¯¯
- [ ] æä¾›ç‰ˆæœ¬è¿ç§»ç¤ºä¾‹

---

### ğŸ”µ 2.5 å®Œæ•´ç¤ºä¾‹é¡¹ç›®

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 3-5å¤©  
**å½±å“èŒƒå›´ï¼š** æ–°å¢`Examples`æ–‡ä»¶å¤¹  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### ç¤ºä¾‹æ¸…å•

| ç¤ºä¾‹åç§° | å†…å®¹ | å­¦ä¹ ç›®æ ‡ |
|---------|------|---------|
| 01-BasicBuff | åŸºç¡€Buffæ·»åŠ /ç§»é™¤ | å¿«é€Ÿä¸Šæ‰‹ |
| 02-StackableBuff | å¯å åŠ Buff | å å±‚ç³»ç»Ÿ |
| 03-DOTEffect | æŒç»­ä¼¤å®³æ•ˆæœ | Effectå¼€å‘ |
| 04-BuffCondition | æ¡ä»¶ç³»ç»Ÿ | æ¡ä»¶åˆ¤æ–­ |
| 05-BuffCombo | Buffç»„åˆ | è¿æºç³»ç»Ÿ |
| 06-BuffArea | åŒºåŸŸæ•ˆæœ | åŒºåŸŸç³»ç»Ÿ |
| 07-SaveLoad | å­˜æ¡£åŠ è½½ | æŒä¹…åŒ– |
| 08-CompleteDemo | å®Œæ•´RPGæ¼”ç¤º | ç»¼åˆåº”ç”¨ |

#### éªŒæ”¶æ ‡å‡†

- [ ] è‡³å°‘8ä¸ªç‹¬ç«‹ç¤ºä¾‹
- [ ] æ¯ä¸ªç¤ºä¾‹æœ‰è¯¦ç»†æ³¨é‡Š
- [ ] æä¾›READMEè¯´æ˜
- [ ] ç¤ºä¾‹å¯ç›´æ¥è¿è¡Œ

---

## Phase 3: å·¥å…·ä¸æ–‡æ¡£

### ğŸ”µ 3.1 å¯è§†åŒ–è°ƒè¯•çª—å£

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½  
**é¢„ä¼°å·¥æ—¶ï¼š** 2-3å¤©  
**å½±å“èŒƒå›´ï¼š** æ–°å¢`Editor/BuffDebugger`æ–‡ä»¶å¤¹  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### åŠŸèƒ½è®¾è®¡

```csharp
// Editor/BuffDebugger/BuffSystemDebugger.cs
#if UNITY_EDITOR
using UnityEditor;
using UnityEngine;

public class BuffSystemDebugger : EditorWindow
{
    private Vector2 scrollPosition;
    private IBuffOwner selectedOwner;
    private bool autoRefresh = true;
    private float refreshInterval = 0.5f;
    private float lastRefreshTime;
    
    [MenuItem("Window/BuffSystem/Debugger")]
    public static void ShowWindow()
    {
        GetWindow<BuffSystemDebugger>("Buff Debugger");
    }
    
    private void OnGUI()
    {
        DrawToolbar();
        
        if (autoRefresh && Time.realtimeSinceStartup - lastRefreshTime > refreshInterval)
        {
            Repaint();
            lastRefreshTime = Time.realtimeSinceStartup;
        }
        
        scrollPosition = EditorGUILayout.BeginScrollView(scrollPosition);
        
        DrawGlobalStats();
        DrawOwnerList();
        
        if (selectedOwner != null)
        {
            DrawOwnerDetails(selectedOwner);
        }
        
        EditorGUILayout.EndScrollView();
    }
    
    private void DrawToolbar()
    {
        EditorGUILayout.BeginHorizontal(EditorStyles.toolbar);
        
        autoRefresh = GUILayout.Toggle(autoRefresh, "Auto Refresh", EditorStyles.toolbarButton);
        
        if (GUILayout.Button("Refresh", EditorStyles.toolbarButton))
        {
            Repaint();
        }
        
        if (GUILayout.Button("Clear All", EditorStyles.toolbarButton))
        {
            if (EditorUtility.DisplayDialog("ç¡®è®¤", "æ¸…é™¤æ‰€æœ‰Buff?", "æ˜¯", "å¦"))
            {
                foreach (var owner in BuffOwner.AllOwners)
                {
                    owner.BuffContainer?.ClearAllBuffs();
                }
            }
        }
        
        EditorGUILayout.EndHorizontal();
    }
    
    private void DrawGlobalStats()
    {
        EditorGUILayout.LabelField("å…¨å±€ç»Ÿè®¡", EditorStyles.boldLabel);
        
        int totalOwners = BuffOwner.AllOwners.Count;
        int totalBuffs = 0;
        
        foreach (var owner in BuffOwner.AllOwners)
        {
            totalBuffs += owner.BuffContainer?.Count ?? 0;
        }
        
        EditorGUILayout.LabelField($"æŒæœ‰è€…æ•°é‡: {totalOwners}");
        EditorGUILayout.LabelField($"Buffæ€»æ•°: {totalBuffs}");
        EditorGUILayout.Space();
    }
    
    private void DrawOwnerList()
    {
        EditorGUILayout.LabelField("æŒæœ‰è€…åˆ—è¡¨", EditorStyles.boldLabel);
        
        foreach (var owner in BuffOwner.AllOwners)
        {
            EditorGUILayout.BeginHorizontal();
            
            bool isSelected = selectedOwner == owner;
            if (GUILayout.Toggle(isSelected, $"{owner.OwnerName} ({owner.BuffContainer?.Count ?? 0})", EditorStyles.radioButton))
            {
                selectedOwner = owner;
            }
            
            EditorGUILayout.EndHorizontal();
        }
        
        EditorGUILayout.Space();
    }
    
    private void DrawOwnerDetails(IBuffOwner owner)
    {
        EditorGUILayout.LabelField($"{owner.OwnerName} çš„Buff", EditorStyles.boldLabel);
        
        if (owner.BuffContainer == null || owner.BuffContainer.Count == 0)
        {
            EditorGUILayout.LabelField("æ— Buff");
            return;
        }
        
        foreach (var buff in owner.BuffContainer.AllBuffs)
        {
            EditorGUILayout.BeginVertical(GUI.skin.box);
            
            EditorGUILayout.LabelField($"{buff.Name} (ID: {buff.DataId})", EditorStyles.boldLabel);
            EditorGUILayout.LabelField($"å±‚æ•°: {buff.CurrentStack}/{buff.MaxStack}");
            EditorGUILayout.LabelField($"å‰©ä½™æ—¶é—´: {(buff.IsPermanent ? "æ°¸ä¹…" : $"{buff.RemainingTime:F1}s")}");
            
            EditorGUILayout.BeginHorizontal();
            
            if (GUILayout.Button("+1å±‚"))
            {
                buff.AddStack(1);
            }
            
            if (GUILayout.Button("-1å±‚"))
            {
                buff.RemoveStack(1);
            }
            
            if (GUILayout.Button("ç§»é™¤"))
            {
                owner.BuffContainer.RemoveBuff(buff);
            }
            
            EditorGUILayout.EndHorizontal();
            
            EditorGUILayout.EndVertical();
            EditorGUILayout.Space();
        }
        
        // å¿«é€Ÿæ·»åŠ Buff
        EditorGUILayout.Space();
        EditorGUILayout.LabelField("å¿«é€Ÿæ·»åŠ Buff", EditorStyles.boldLabel);
        
        // TODO: ä¸‹æ‹‰é€‰æ‹©Buffï¼Œè¾“å…¥æ¡†æ·»åŠ 
    }
}
#endif
```

#### éªŒæ”¶æ ‡å‡†

- [ ] æ˜¾ç¤ºæ‰€æœ‰BuffOwneråˆ—è¡¨
- [ ] æ˜¾ç¤ºæ¯ä¸ªOwnerçš„Buffè¯¦æƒ…
- [ ] æ”¯æŒæ‰‹åŠ¨æ·»åŠ /ç§»é™¤Buff
- [ ] æ”¯æŒä¿®æ”¹å±‚æ•°
- [ ] è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½

---

### ğŸ”µ 3.2 æ€§èƒ½ç›‘æ§å™¨

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½  
**é¢„ä¼°å·¥æ—¶ï¼š** 1-2å¤©  
**å½±å“èŒƒå›´ï¼š** æ–°å¢`Runtime/BuffProfiler.cs`  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### å®ç°æ–¹æ¡ˆ

```csharp
// Runtime/BuffProfiler.cs
public class BuffProfiler : MonoBehaviour
{
    [System.Serializable]
    public class ProfileData
    {
        public float UpdateTime;
        public int BuffCount;
        public int AddCount;
        public int RemoveCount;
        public float AverageBuffLifetime;
    }
    
    private readonly Queue<ProfileData> history = new();
    private const int MaxHistory = 100;
    
    private int frameAddCount;
    private int frameRemoveCount;
    private readonly Dictionary<int, float> buffAddTimes = new();
    
    public static BuffProfiler Instance { get; private set; }
    
    private void Awake()
    {
        Instance = this;
    }
    
    public void RecordAdd(IBuff buff)
    {
        frameAddCount++;
        buffAddTimes[buff.InstanceId] = Time.time;
    }
    
    public void RecordRemove(IBuff buff)
    {
        frameRemoveCount++;
        if (buffAddTimes.TryGetValue(buff.InstanceId, out float addTime))
        {
            float lifetime = Time.time - addTime;
            buffAddTimes.Remove(buff.InstanceId);
        }
    }
    
    private void LateUpdate()
    {
        var data = new ProfileData
        {
            UpdateTime = Time.time,
            BuffCount = CountAllBuffs(),
            AddCount = frameAddCount,
            RemoveCount = frameRemoveCount
        };
        
        history.Enqueue(data);
        if (history.Count > MaxHistory)
        {
            history.Dequeue();
        }
        
        frameAddCount = 0;
        frameRemoveCount = 0;
    }
    
    private int CountAllBuffs()
    {
        int count = 0;
        foreach (var owner in BuffOwner.AllOwners)
        {
            count += owner.BuffContainer?.Count ?? 0;
        }
        return count;
    }
    
    public IReadOnlyCollection<ProfileData> GetHistory() => history;
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] è®°å½•Buffæ•°é‡å˜åŒ–
- [ ] è®°å½•æ·»åŠ /ç§»é™¤é¢‘ç‡
- [ ] æä¾›å†å²æ•°æ®æŸ¥è¯¢
- [ ] å¯è§†åŒ–å›¾è¡¨ï¼ˆå¯é€‰ï¼‰

---

### ğŸ”µ 3.3 æ–‡æ¡£å®Œå–„

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­  
**é¢„ä¼°å·¥æ—¶ï¼š** 3-5å¤©  
**å½±å“èŒƒå›´ï¼š** `Documentation`æ–‡ä»¶å¤¹  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### æ–‡æ¡£æ¸…å•

| æ–‡æ¡£ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| QuickStart.md | â¬œ | 15åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹ |
| Architecture.md | âœ… | æ¶æ„è®¾è®¡è¯¦ç»† |
| API-Reference.md | â¬œ | å®Œæ•´APIå‚è€ƒ |
| Effect-Guide.md | â¬œ | Effectå¼€å‘æŒ‡å— |
| Condition-Guide.md | â¬œ | æ¡ä»¶ç³»ç»ŸæŒ‡å— |
| Save-Load-Guide.md | â¬œ | å­˜æ¡£ç³»ç»ŸæŒ‡å— |
| Performance-Tips.md | â¬œ | æ€§èƒ½ä¼˜åŒ–å»ºè®® |
| FAQ.md | âœ… | å¸¸è§é—®é¢˜ |
| Video-Tutorials.md | â¬œ | è§†é¢‘æ•™ç¨‹é“¾æ¥ |

#### éªŒæ”¶æ ‡å‡†

- [ ] æ‰€æœ‰æ–‡æ¡£å®Œæˆ
- [ ] åŒ…å«ä»£ç ç¤ºä¾‹
- [ ] åŒ…å«æˆªå›¾/å›¾ç¤º
- [ ] ä¸­æ–‡/è‹±æ–‡åŒè¯­ï¼ˆå¯é€‰ï¼‰

---

## Phase 4: é«˜çº§ç‰¹æ€§

### ğŸ”µ 4.1 ç½‘ç»œåŒæ­¥æ”¯æŒ

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½  
**é¢„ä¼°å·¥æ—¶ï¼š** 1-2å‘¨  
**å½±å“èŒƒå›´ï¼š** æ–°å¢`Networking`æ–‡ä»¶å¤¹  
**çŠ¶æ€ï¼š** â¬œ å¾…å®Œæˆï¼ˆç»§æ‰¿v3.0ï¼‰

#### è®¾è®¡ç›®æ ‡

æ”¯æŒMirror/Netcode for GameObjectsç­‰ç½‘ç»œæ¡†æ¶ï¼Œå®ç°BuffçŠ¶æ€åŒæ­¥ã€‚

#### å®ç°æ€è·¯

```csharp
// Networking/BuffNetworkSync.csï¼ˆæ¦‚å¿µè®¾è®¡ï¼‰
public class BuffNetworkSync : NetworkBehaviour
{
    private IBuffOwner buffOwner;
    
    // ä½¿ç”¨SyncListåŒæ­¥Buffåˆ—è¡¨
    private readonly SyncList<BuffSyncData> syncedBuffs = new();
    
    public override void OnStartServer()
    {
        buffOwner = GetComponent<IBuffOwner>();
        if (buffOwner != null)
        {
            // è®¢é˜…äº‹ä»¶ï¼ŒåŒæ­¥åˆ°å®¢æˆ·ç«¯
            buffOwner.LocalEvents.OnBuffAdded += OnServerBuffAdded;
            buffOwner.LocalEvents.OnBuffRemoved += OnServerBuffRemoved;
        }
    }
    
    [Server]
    private void OnServerBuffAdded(IBuff buff)
    {
        syncedBuffs.Add(new BuffSyncData(buff));
    }
    
    [Server]
    private void OnServerBuffRemoved(IBuff buff)
    {
        // ä»syncedBuffsç§»é™¤
    }
    
    // å®¢æˆ·ç«¯æ¥æ”¶åŒæ­¥
    private void OnSyncedBuffsChanged(SyncList<BuffSyncData>.Operation op, int index, BuffSyncData item)
    {
        if (!isServer)
        {
            // å®¢æˆ·ç«¯åº”ç”¨åŒæ­¥æ•°æ®
            ApplySyncData(op, index, item);
        }
    }
}
```

#### éªŒæ”¶æ ‡å‡†

- [ ] æ”¯æŒMirroræ¡†æ¶
- [ ] æ”¯æŒNetcode for GameObjects
- [ ] æœåŠ¡å™¨æƒå¨
- [ ] å®¢æˆ·ç«¯é¢„æµ‹ï¼ˆå¯é€‰ï¼‰

---

### ğŸ”µ 4.2 Buffå¿«ç…§ç³»ç»Ÿ

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½  
**é¢„ä¼°å·¥æ—¶ï¼š** 3-5å¤©  
**å½±å“èŒƒå›´ï¼š** `BuffContainer`æ‰©å±•  
**çŠ¶æ€ï¼š** ğŸŸ¢ æ–°å¢ï¼ˆv4.0ï¼‰

#### è®¾è®¡ç›®æ ‡

å®ç°DOTA2é£æ ¼çš„å¿«ç…§æœºåˆ¶ï¼ŒBuffæ•ˆæœåŸºäºå¿«ç…§æ—¶çš„å±æ€§è®¡ç®—ã€‚

#### å®ç°æ€è·¯

```csharp
// Runtime/BuffSnapshot.cs
public class BuffSnapshot
{
    public float Timestamp { get; set; }
    public Dictionary<string, float> Attributes { get; set; }
    
    public static BuffSnapshot Capture(IBuffOwner owner)
    {
        var snapshot = new BuffSnapshot
        {
            Timestamp = Time.time,
            Attributes = new Dictionary<string, float>()
        };
        
        if (owner is IAttributeOwner attrOwner)
        {
            snapshot.Attributes["Attack"] = attrOwner.GetAttack();
            snapshot.Attributes["Defense"] = attrOwner.GetDefense();
            // ... å…¶ä»–å±æ€§
        }
        
        return snapshot;
    }
}

// åœ¨Buffé€»è¾‘ä¸­ä½¿ç”¨å¿«ç…§
public class SnapshotBasedDOTEffect : EffectBase, IBuffLogicUpdate
{
    private BuffSnapshot snapshot;
    
    public override void Execute(IBuff buff)
    {
        // æ•è·å¿«ç…§
        snapshot = BuffSnapshot.Capture(buff.Owner);
    }
    
    public void OnLogicUpdate(float deltaTime)
    {
        // åŸºäºå¿«ç…§è®¡ç®—ä¼¤å®³ï¼Œè€Œéå®æ—¶å±æ€§
        float damage = CalculateDamageBasedOnSnapshot(snapshot);
        // ...
    }
}
```

---

## ä¼˜åŒ–å®æ–½æ£€æŸ¥æ¸…å•

### Phase 1 æ£€æŸ¥æ¸…å•

- [x] 1.1 BuffDatabaseæ— é”åŒ–
- [x] 1.2 ä¼˜åŒ–GetBuffsByTagå®ç°
- [x] 1.3 ä¼˜åŒ–BuffContainer.AllBuffsç¼“å­˜
- [x] 1.4 å®Œå–„ç­–ç•¥æ¨¡å¼åº”ç”¨
- [x] 1.5 ä»£ç ç²¾ç®€ä¸é‡æ„

### Phase 2 æ£€æŸ¥æ¸…å•

- [ ] 2.1 å†…ç½®Effectåº“
- [x] 2.2 Buffå…ç–«ç³»ç»Ÿ
- [x] 2.3 BuffåŒºåŸŸç³»ç»Ÿ
- [ ] 2.4 å­˜æ¡£ç‰ˆæœ¬ç®¡ç†
- [ ] 2.5 å®Œæ•´ç¤ºä¾‹é¡¹ç›®

### Phase 3 æ£€æŸ¥æ¸…å•

- [ ] 3.1 å¯è§†åŒ–è°ƒè¯•çª—å£
- [ ] 3.2 æ€§èƒ½ç›‘æ§å™¨
- [ ] 3.3 æ–‡æ¡£å®Œå–„

### Phase 4 æ£€æŸ¥æ¸…å•

- [ ] 4.1 ç½‘ç»œåŒæ­¥æ”¯æŒ
- [x] 4.2 Buffå¿«ç…§ç³»ç»Ÿ

---

## ç‰ˆæœ¬å‘å¸ƒè®¡åˆ’

### v4.0.0 - æ€§èƒ½ä¼˜åŒ–ç‰ˆ

**å‘å¸ƒæ—¶é—´ï¼š** Phase 1å®Œæˆå  
**ä¸»è¦å†…å®¹ï¼š**
- BuffDatabaseæ— é”åŒ–
- æŸ¥è¯¢APIä¼˜åŒ–
- ç­–ç•¥æ¨¡å¼å®Œå–„

### v4.1.0 - åŠŸèƒ½æ‰©å±•ç‰ˆ

**å‘å¸ƒæ—¶é—´ï¼š** Phase 2å®Œæˆå  
**ä¸»è¦å†…å®¹ï¼š**
- å†…ç½®Effectåº“
- Buffå…ç–«ç³»ç»Ÿ
- BuffåŒºåŸŸç³»ç»Ÿ
- å­˜æ¡£ç‰ˆæœ¬ç®¡ç†

### v4.2.0 - å·¥å…·å®Œå–„ç‰ˆ

**å‘å¸ƒæ—¶é—´ï¼š** Phase 3å®Œæˆå  
**ä¸»è¦å†…å®¹ï¼š**
- å¯è§†åŒ–è°ƒè¯•çª—å£
- æ€§èƒ½ç›‘æ§å™¨
- å®Œæ•´æ–‡æ¡£

### v4.3.0 - é«˜çº§ç‰¹æ€§ç‰ˆ

**å‘å¸ƒæ—¶é—´ï¼š** Phase 4å®Œæˆå  
**ä¸»è¦å†…å®¹ï¼š**
- ç½‘ç»œåŒæ­¥æ”¯æŒ
- Buffå¿«ç…§ç³»ç»Ÿ

---

## é™„å½•

### A. ä¼˜åŒ–ä¼˜å…ˆçº§è¯´æ˜

| ä¼˜å…ˆçº§ | æ ‡è¯† | è¯´æ˜ |
|--------|------|------|
| é«˜ | ğŸ”´ | æ ¸å¿ƒä¼˜åŒ–ï¼Œå»ºè®®ä¼˜å…ˆå®Œæˆ |
| ä¸­ | ğŸŸ¡ | é‡è¦ä¼˜åŒ–ï¼Œå»ºè®®æŒ‰è®¡åˆ’å®Œæˆ |
| ä½ | ğŸŸ¢ | å¯é€‰ä¼˜åŒ–ï¼Œæ ¹æ®éœ€æ±‚å®Œæˆ |

### B. çŠ¶æ€æ ‡è¯†è¯´æ˜

| çŠ¶æ€ | æ ‡è¯† | è¯´æ˜ |
|------|------|------|
| å·²å®Œæˆ | âœ… | å·²å¼€å‘å¹¶æµ‹è¯•å®Œæˆ |
| å¾…å®Œæˆ | â¬œ | å¾…å¼€å‘ |
| æ–°å¢ | ğŸŸ¢ | v4.0æ–°å¢ä¼˜åŒ–é¡¹ |
| ä¿ç•™ | ğŸ”µ | ç»§æ‰¿è‡ªv3.0çš„ä¼˜åŒ–é¡¹ |

---

*æ–‡æ¡£ç»“æŸ*
