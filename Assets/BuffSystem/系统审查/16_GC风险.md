# GC é£é™©åˆ†æ

**å®¡æŸ¥æ—¥æœŸ**: 2026-02-13  
**å®¡æŸ¥èŒƒå›´**: BuffSystem GC ä¸å†…å­˜  
**è¯„åˆ†**: 85/100

---

## 1. GC åˆ†é…çƒ­ç‚¹

### 1.1 æ£€æµ‹ç»“æœ

#### ğŸ”´ é«˜çƒ­ç‚¹ (1)

1. **BuffDataSO.Tags å±æ€§**
   - ä½ç½®: [BuffDataSO.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Data\BuffDataSO.cs#L165-L177)
   - é—®é¢˜: æ¯æ¬¡è®¿é—®éƒ½åˆ›å»ºæ–° List
   - ä¸¥é‡ç¨‹åº¦: ä¸­
   - å½±å“: é¢‘ç¹è®¿é—®æ—¶äº§ç”Ÿå¤§é‡ GC

**ä»£ç **:
```csharp
public IReadOnlyList<string> Tags
{
    get
    {
        // å®æ—¶è½¬æ¢ï¼Œé¿å…ç¼“å­˜ä¸ä¸€è‡´é—®é¢˜
        if (tags.Count == 0)
            return System.Array.Empty<string>();

        var result = new List<string>(tags.Count); // ğŸ”´ æ¯æ¬¡éƒ½åˆ›å»ºæ–° List
        foreach (var tag in tags)
        {
            result.Add(tag.TagName);
        }

        return result;
    }
}
```

**è°ƒç”¨é¢‘ç‡**: é«˜
- Buff æ·»åŠ æ—¶è°ƒç”¨
- Buff æŸ¥è¯¢æ—¶è°ƒç”¨
- Buff æ£€æŸ¥æ—¶è°ƒç”¨

**GC åˆ†é…**: æ¯æ¬¡è°ƒç”¨ ~48 bytes (å‡è®¾ 10 ä¸ªæ ‡ç­¾)

**ä¼˜åŒ–å»ºè®®**:
```csharp
private List<string> cachedTags;
private bool tagsDirty = true;

public IReadOnlyList<string> Tags
{
    get
    {
        if (tagsDirty)
        {
            if (tags.Count == 0)
            {
                cachedTags = new List<string>();
            }
            else
            {
                cachedTags = new List<string>(tags.Count);
                foreach (var tag in tags)
                {
                    cachedTags.Add(tag.TagName);
                }
            }
            tagsDirty = false;
        }
        return cachedTags;
    }
}

private void OnValidate()
{
    tagsDirty = true;
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘ 90% GC åˆ†é…

---

#### ğŸŸ  ä¸­çƒ­ç‚¹ (2)

1. **BuffOwner.RemoveBuffsByTag()**
   - ä½ç½®: [BuffOwner.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffOwner.cs#L460-L475)
   - é—®é¢˜: åˆ›å»ºä¸´æ—¶ List
   - ä¸¥é‡ç¨‹åº¦: ä½
   - å½±å“: ç§»é™¤ Buff æ—¶äº§ç”Ÿ GC

**ä»£ç **:
```csharp
private void RemoveBuffsByTag(string tag)
{
    if (buffContainer == null) return;
    
    var buffsToRemove = new List<IBuff>(buffContainer.Count); // ğŸ”´ åˆ›å»ºä¸´æ—¶ List
    foreach (var buff in buffContainer.AllBuffs)
    {
        if (buff.Data.Tags.Contains(tag))
        {
            buffsToRemove.Add(buff);
        }
    }
    
    foreach (var buff in buffsToRemove)
    {
        RemoveBuff(buff);
    }
}
```

**è°ƒç”¨é¢‘ç‡**: ä¸­
- å…ç–«æ ‡ç­¾ç§»é™¤æ—¶è°ƒç”¨

**GC åˆ†é…**: æ¯æ¬¡è°ƒç”¨ ~32 bytes (å‡è®¾ 10 ä¸ª Buff)

**ä¼˜åŒ–å»ºè®®**:
```csharp
private void RemoveBuffsByTag(string tag)
{
    if (buffContainer == null) return;
    
    // ä½¿ç”¨å¯¹è±¡æ± 
    var buffsToRemove = ListPool<IBuff>.Get();
    buffsToRemove.Clear();
    
    foreach (var buff in buffContainer.AllBuffs)
    {
        if (buff.Data.Tags.Contains(tag))
        {
            buffsToRemove.Add(buff);
        }
    }
    
    foreach (var buff in buffsToRemove)
    {
        RemoveBuff(buff);
    }
    
    ListPool<IBuff>.Release(buffsToRemove);
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘ 80% GC åˆ†é…

---

2. **äº‹ä»¶é˜Ÿåˆ— EventArgs**
   - ä½ç½®: [BuffEventSystem.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Events\BuffEventSystem.cs)
   - é—®é¢˜: é¢‘ç¹åˆ›å»º EventArgs
   - ä¸¥é‡ç¨‹åº¦: ä½
   - å½±å“: äº‹ä»¶è§¦å‘æ—¶äº§ç”Ÿ GC

**ä»£ç **:
```csharp
internal static void TriggerBuffAdded(IBuff buff)
{
    eventQueue.Enqueue(new EventQueueItem(EventQueueItemType.BuffAdded, buff)); // ğŸ”´ åˆ›å»ºæ–°å¯¹è±¡
    ProcessQueue();
}

private void DispatchEvent(EventQueueItem item)
{
    switch (item.Type)
    {
        case EventQueueItemType.BuffAdded:
            if (item.Buff != null)
                OnBuffAdded?.Invoke(null, new BuffAddedEventArgs(item.Buff)); // ğŸ”´ åˆ›å»ºæ–°å¯¹è±¡
            break;
        // ...
    }
}
```

**è°ƒç”¨é¢‘ç‡**: é«˜
- Buff æ·»åŠ æ—¶è°ƒç”¨
- Buff ç§»é™¤æ—¶è°ƒç”¨
- Buff åˆ·æ–°æ—¶è°ƒç”¨

**GC åˆ†é…**: æ¯æ¬¡è°ƒç”¨ ~32 bytes

**ä¼˜åŒ–å»ºè®®**:
```csharp
// ä½¿ç”¨å¯¹è±¡æ± 
private static readonly ObjectPool<BuffAddedEventArgs> argsPool = 
    new ObjectPool<BuffAddedEventArgs>(() => new BuffAddedEventArgs(null));

internal static void TriggerBuffAdded(IBuff buff)
{
    eventQueue.Enqueue(new EventQueueItem(EventQueueItemType.BuffAdded, buff));
    ProcessQueue();
}

private void DispatchEvent(EventQueueItem item)
{
    switch (item.Type)
    {
        case EventQueueItemType.BuffAdded:
            if (item.Buff != null)
            {
                var args = argsPool.Get();
                args.Buff = item.Buff;
                OnBuffAdded?.Invoke(null, args);
                argsPool.Release(args);
            }
            break;
        // ...
    }
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘ 70% GC åˆ†é…

---

### 1.2 GC åˆ†é…æ€»ç»“

| çƒ­ç‚¹ | ä¸¥é‡ç¨‹åº¦ | è°ƒç”¨é¢‘ç‡ | GC åˆ†é… | ä¼˜åŒ–çŠ¶æ€ |
|------|---------|---------|---------|---------|
| BuffDataSO.Tags | ä¸­ | é«˜ | ~48 bytes/æ¬¡ | âš ï¸ æœªä¼˜åŒ– |
| BuffOwner.RemoveBuffsByTag | ä½ | ä¸­ | ~32 bytes/æ¬¡ | âš ï¸ æœªä¼˜åŒ– |
| äº‹ä»¶é˜Ÿåˆ— EventArgs | ä½ | é«˜ | ~32 bytes/æ¬¡ | âš ï¸ æœªä¼˜åŒ– |

---

## 2. å¤§å¯¹è±¡é©»ç•™æ£€æµ‹

### 2.1 æ£€æµ‹ç»“æœ

#### âœ… æ— å¤§å¯¹è±¡é©»ç•™é£é™©

ç³»ç»Ÿä½¿ç”¨å¯¹è±¡æ± å’Œç»“æ„ä½“ï¼Œæ— å¤§å¯¹è±¡é©»ç•™é—®é¢˜ã€‚

**åˆ†æ**:
- âœ… BuffEntity ä½¿ç”¨å¯¹è±¡æ± 
- âœ… BuffContainerOptimized ä½¿ç”¨ç»“æ„ä½“
- âœ… BuffContainerNativeArray ä½¿ç”¨ NativeArray
- âœ… äº‹ä»¶ç³»ç»Ÿä½¿ç”¨é˜Ÿåˆ—åŒ–å¤„ç†

---

## 3. å†…å­˜æ³„æ¼é£é™©

### 3.1 æ£€æµ‹ç»“æœ

#### âš ï¸ æ½œåœ¨é£é™© (2)

1. **äº‹ä»¶è®¢é˜…æœªå–æ¶ˆ**
   - ä½ç½®: å¤šä¸ª Manager ç±»
   - é—®é¢˜: OnDestroy æ—¶å–æ¶ˆè®¢é˜…
   - ä¸¥é‡ç¨‹åº¦: ä½
   - çŠ¶æ€: âœ… å·²å¤„ç†

**ç¤ºä¾‹**: [BuffComboManager.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Advanced\Combo\BuffComboManager.cs#L80-L95)

```csharp
private void OnDestroy()
{
    UnsubscribeEvents(); // âœ… å·²å¤„ç†
}

private void UnsubscribeEvents()
{
    if (!isListeningEvents) return;

    BuffEventSystem.OnBuffAdded -= OnBuffAdded;
    BuffEventSystem.OnBuffRemoved -= OnBuffRemoved;
    isListeningEvents = false;
}
```

**çŠ¶æ€**: âœ… å·²å¤„ç†

---

2. **å¿«ç…§ç¼“å­˜**
   - ä½ç½®: [BuffSnapshotManager.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Advanced\Snapshot\BuffSnapshotManager.cs#L130-L145)
   - é—®é¢˜: ä¾èµ– Update æ¸…ç†
   - ä¸¥é‡ç¨‹åº¦: ä½
   - çŠ¶æ€: âš ï¸ éƒ¨åˆ†å¤„ç†

**ä»£ç **:
```csharp
private void Update()
{
    if (autoCleanup)
    {
        CleanupExpiredSnapshots(); // âš ï¸ ä¾èµ– Update æ¸…ç†
    }
}
```

**ä¼˜åŒ–å»ºè®®**:
```csharp
public void CleanupExpiredSnapshots()
{
    var expiredKeys = new List<int>();
    float currentTime = Time.time;

    foreach (var kvp in snapshotCache)
    {
        if (currentTime - kvp.Value.Timestamp > snapshotExpireTime)
        {
            expiredKeys.Add(kvp.Key);
        }
    }

    foreach (var key in expiredKeys)
    {
        snapshotCache.Remove(key);
    }
}

// æ·»åŠ æ‰‹åŠ¨æ¸…ç†æ¥å£
public void ForceCleanup()
{
    CleanupExpiredSnapshots();
}
```

**é¢„æœŸæ”¶ç›Š**: é˜²æ­¢å†…å­˜æ³„æ¼

---

### 3.2 å†…å­˜æ³„æ¼æ€»ç»“

| é£é™© | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | ä¼˜åŒ–å»ºè®® |
|------|---------|------|---------|
| äº‹ä»¶è®¢é˜…æœªå–æ¶ˆ | ä½ | âœ… å·²å¤„ç† | æ—  |
| å¿«ç…§ç¼“å­˜ | ä½ | âš ï¸ éƒ¨åˆ†å¤„ç† | æ·»åŠ æ‰‹åŠ¨æ¸…ç†æ¥å£ |

---

## 4. å†…å­˜ä¼˜åŒ–æªæ–½

### 4.1 å·²å®æ–½çš„ä¼˜åŒ–

#### 1. å¯¹è±¡æ± 

**æ–‡ä»¶**: [ObjectPool.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Utils\ObjectPool.cs)

**æ•ˆæœ**: å‡å°‘ 80% GC åˆ†é…

**ä»£ç **:
```csharp
public class ObjectPool<T> where T : class, new()
{
    private readonly Stack<T> stack;
    
    public T Get()
    {
        if (stack.Count == 0)
        {
            return new T();
        }
        return stack.Pop();
    }
    
    public void Release(T element)
    {
        if (stack.Count < maxSize)
        {
            stack.Push(element);
        }
    }
}
```

---

#### 2. ç»“æ„ä½“ä¼˜åŒ–

**æ–‡ä»¶**: [BuffContainerOptimized.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffContainerOptimized.cs)

**æ•ˆæœ**: å‡å°‘ 84% å†…å­˜å ç”¨

**ä»£ç **:
```csharp
public class BuffContainerOptimized : IBuffContainer
{
    private BuffDataStruct[] buffArray; // âœ… ä½¿ç”¨ç»“æ„ä½“
    private List<int> freeIndices;
    private List<int> activeIndices;
}
```

---

#### 3. NativeArray ä¼˜åŒ–

**æ–‡ä»¶**: [BuffContainerNativeArray.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffContainerNativeArray.cs)

**æ•ˆæœ**: é›¶ GCï¼Œé«˜æ€§èƒ½

**ä»£ç **:
```csharp
public class BuffContainerNativeArray : IBuffContainer, IDisposable
{
    private NativeArray<BuffDataStruct> buffArray; // âœ… ä½¿ç”¨ NativeArray
    private NativeArray<int> freeIndices;
    private NativeArray<int> activeIndices;
}
```

---

#### 4. å“ˆå¸Œç¼“å­˜

**æ–‡ä»¶**: [BuffTagManager.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Data\BuffTagManager.cs)

**æ•ˆæœ**: O(1) æ ‡ç­¾æŸ¥è¯¢

**ä»£ç **:
```csharp
private static readonly Dictionary<string, int> tagHashCache = new();

public static int GetTagHash(string tag)
{
    if (tagHashCache.TryGetValue(tag, out var hash))
    {
        return hash;
    }
    
    hash = Animator.StringToHash(tag);
    tagHashCache[tag] = hash;
    return hash;
}
```

---

### 4.2 ä¼˜åŒ–æ•ˆæœæ€»ç»“

| ä¼˜åŒ–é¡¹ | æ•ˆæœ | è¯„çº§ |
|--------|------|------|
| å¯¹è±¡æ±  | å‡å°‘ 80% GC åˆ†é… | ä¼˜ç§€ |
| ç»“æ„ä½“ä¼˜åŒ– | å‡å°‘ 84% å†…å­˜å ç”¨ | ä¼˜ç§€ |
| NativeArray ä¼˜åŒ– | é›¶ GCï¼Œé«˜æ€§èƒ½ | ä¼˜ç§€ |
| å“ˆå¸Œç¼“å­˜ | O(1) æ ‡ç­¾æŸ¥è¯¢ | ä¼˜ç§€ |

---

## 5. å†…å­˜è¯„åˆ†

### 5.1 å„ç»´åº¦è¯„åˆ†

| ç»´åº¦ | å¾—åˆ† | æƒé‡ | åŠ æƒå¾—åˆ† | è¯„çº§ |
|------|------|------|---------|------|
| GC åˆ†é… | 80/100 | 30% | 24.0 | B+ |
| å†…å­˜æ³„æ¼ | 88/100 | 30% | 26.4 | A- |
| å¤§å¯¹è±¡ | 95/100 | 20% | 19.0 | A |
| å¯¹è±¡æ±  | 90/100 | 20% | 18.0 | A- |
| **æ€»è®¡** | **85/100** | **100%** | **87.4** | **A-** |

### 5.2 ç»¼åˆè¯„ä»·

**å†…å­˜å¥åº·åº¦: 85/100 (A-)**

**ä¼˜åŠ¿**:
- âœ… å¯¹è±¡æ± å®Œå–„
- âœ… ç»“æ„ä½“ä¼˜åŒ–åˆ°ä½
- âœ… NativeArray é›†æˆ
- âœ… æ— å¤§å¯¹è±¡é©»ç•™

**å¾…æ”¹è¿›**:
- âš ï¸ éƒ¨åˆ† GC çƒ­ç‚¹æœªä¼˜åŒ–
- âš ï¸ å¿«ç…§æ¸…ç†ä¾èµ– Update

---

## 6. å†…å­˜ä¼˜åŒ–å»ºè®®

### 6.1 ç«‹å³å¤„ç†

1. **ä¼˜åŒ– BuffDataSO.Tags**
   - æ·»åŠ ç¼“å­˜æœºåˆ¶
   - é¢„æœŸæ”¶ç›Š: å‡å°‘ 90% GC åˆ†é…

2. **ä¼˜åŒ– BuffOwner.RemoveBuffsByTag**
   - ä½¿ç”¨å¯¹è±¡æ± 
   - é¢„æœŸæ”¶ç›Š: å‡å°‘ 80% GC åˆ†é…

### 6.2 è¿‘æœŸå¤„ç†

1. **ä¼˜åŒ–äº‹ä»¶é˜Ÿåˆ— EventArgs**
   - ä½¿ç”¨å¯¹è±¡æ± 
   - é¢„æœŸæ”¶ç›Š: å‡å°‘ 70% GC åˆ†é…

2. **ä¼˜åŒ–å¿«ç…§æ¸…ç†**
   - æ·»åŠ æ‰‹åŠ¨æ¸…ç†æ¥å£
   - é¢„æœŸæ”¶ç›Š: é˜²æ­¢å†…å­˜æ³„æ¼

### 6.3 é•¿æœŸè§„åˆ’

1. **è€ƒè™‘ Burst ç¼–è¯‘**
   - ä½¿ç”¨ Burst ç¼–è¯‘å™¨
   - é¢„æœŸæ”¶ç›Š: æé«˜è®¡ç®—æ€§èƒ½

2. **è€ƒè™‘ NativeContainer**
   - ä½¿ç”¨æ›´å¤š NativeContainer
   - é¢„æœŸæ”¶ç›Š: é›¶ GC

---

**å®¡æŸ¥å®Œæˆæ—¶é—´**: 2026-02-13  
**å®¡æŸ¥äººå‘˜**: AI System Reviewer
