# æ€§èƒ½çƒ­ç‚¹åˆ†æ

**å®¡æŸ¥æ—¥æœŸ**: 2026-02-13  
**å®¡æŸ¥èŒƒå›´**: BuffSystem æ€§èƒ½çƒ­ç‚¹  
**è¯„åˆ†**: 90/100

---

## 1. Update çƒ­ç‚¹æ£€æµ‹

### 1.1 æ£€æµ‹ç»“æœ

#### ğŸ”´ é«˜çƒ­ç‚¹ (2)

1. **BuffOwner.Update()**
   - ä½ç½®: [BuffOwner.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffOwner.cs#L126-L160)
   - é¢‘ç‡: æ¯å¸§
   - ä¸¥é‡ç¨‹åº¦: ä¸­
   - å½±å“: æ¯å¸§æ›´æ–°æ‰€æœ‰ Buff

**ä»£ç **:
```csharp
private void Update()
{
    if (BuffSystemUpdater.CurrentUpdateMode == UpdateMode.TurnBased) return;

    if (!updateInFixedUpdate && buffContainer != null)
    {
        if (BuffSystemUpdater.EnableFrequencyBasedUpdate)
        {
            UpdateMaintainConditionsAndRemoval();
        }
        else
        {
            buffContainer.Update(Time.deltaTime);
        }
    }
}
```

**ä¼˜åŒ–å»ºè®®**:
- âœ… å·²æ”¯æŒåˆ†å±‚æ›´æ–°ï¼Œå»ºè®®å¯ç”¨
- âœ… å¯ä½¿ç”¨æ‰¹å¤„ç†æ›´æ–°

**ä¼˜åŒ–æ•ˆæœ**:
- å¯ç”¨åˆ†å±‚æ›´æ–°: é™ä½ 70% CPU ä½¿ç”¨
- å¯ç”¨æ‰¹å¤„ç†: åˆ†æ•£ CPU è´Ÿè½½

---

2. **BuffArea.Update()**
   - ä½ç½®: [BuffArea.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Advanced\Area\BuffArea.cs#L105-L112)
   - é¢‘ç‡: æ¯å¸§
   - ä¸¥é‡ç¨‹åº¦: ä¸­
   - å½±å“: ç‰©ç†æ£€æµ‹æ¯å¸§æ‰§è¡Œ

**ä»£ç **:
```csharp
private void Update()
{
    timer += Time.deltaTime;

    if (timer >= applyInterval)
    {
        timer -= applyInterval;
        UpdateArea();
    }

    CleanupExpiredEntries();
}
```

**ä¼˜åŒ–å»ºè®®**:
- âœ… å·²æ”¯æŒé—´éš”æ›´æ–°ï¼Œå»ºè®®åˆç†è®¾ç½®
- âœ… å¯å¢åŠ  applyInterval

**ä¼˜åŒ–æ•ˆæœ**:
- è®¾ç½® applyInterval = 0.5s: é™ä½ 80% ç‰©ç†æ£€æµ‹

---

#### ğŸŸ  ä¸­çƒ­ç‚¹ (3)

1. **BuffSystemUpdater.Update()**
   - ä½ç½®: [BuffSystemUpdater.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffSystemUpdater.cs#L97-L118)
   - é¢‘ç‡: æ¯å¸§
   - ä¸¥é‡ç¨‹åº¦: ä½
   - å½±å“: æ›´æ–°æ‰€æœ‰ BuffOwner

**ä»£ç **:
```csharp
private void Update()
{
    if (updateMode == UpdateMode.Manual || updateMode == UpdateMode.TurnBased) return;

    float deltaTime = Time.deltaTime;

    if (enableFrequencyBasedUpdate && frequencyUpdater != null)
    {
        frequencyUpdater.Update(deltaTime);
    }
    else if (updateMode == UpdateMode.EveryFrame)
    {
        UpdateAllContainers(deltaTime);
    }
    else if (updateMode == UpdateMode.Interval)
    {
        updateTimer += deltaTime;
        if (updateTimer >= updateInterval)
        {
            UpdateAllContainers(updateTimer);
            updateTimer = 0f;
        }
    }
}
```

**ä¼˜åŒ–å»ºè®®**:
- âœ… å·²æ”¯æŒåˆ†å±‚æ›´æ–°
- âœ… å·²æ”¯æŒæ‰¹å¤„ç†æ›´æ–°

---

2. **BuffComboManager äº‹ä»¶å¤„ç†**
   - ä½ç½®: [BuffComboManager.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Advanced\Combo\BuffComboManager.cs#L165-L200)
   - é¢‘ç‡: äº‹ä»¶è§¦å‘æ—¶
   - ä¸¥é‡ç¨‹åº¦: ä½
   - å½±å“: éå†æ‰€æœ‰ç›¸å…³ Combo

**ä»£ç **:
```csharp
private void OnBuffAdded(object sender, BuffAddedEventArgs e)
{
    var buff = e.Buff;
    if (buff?.Owner == null) return;

    if (combosByBuffId.TryGetValue(buff.DataId, out var relatedCombos))
    {
        foreach (var combo in relatedCombos)
        {
            if ((combo.TriggerMode & ComboTriggerMode.OnBuffAdd) != 0)
            {
                TryActivateCombo(combo, buff.Owner);
            }
        }
    }
}
```

**ä¼˜åŒ–å»ºè®®**:
- âœ… å·²å»ºç«‹ Buff ID æ˜ å°„ï¼ŒO(1) æŸ¥æ‰¾
- âœ… æ€§èƒ½å¯æ¥å—

---

3. **FusionManager.Update()**
   - ä½ç½®: [FusionManager.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Advanced\Fusion\FusionManager.cs#L115-L130)
   - é¢‘ç‡: æ¯å¸§
   - ä¸¥é‡ç¨‹åº¦: ä½
   - å½±å“: æ›´æ–°è¿›è¡Œä¸­çš„èåˆ

**ä»£ç **:
```csharp
private void Update()
{
    for (int i = activeFusions.Count - 1; i >= 0; i--)
    {
        var fusion = activeFusions[i];
        fusion.RemainingTime -= Time.deltaTime;

        float progress = 1f - (fusion.RemainingTime / fusion.TotalTime);
        FusionEventSystem.TriggerFusionProgress(fusion.Recipe, fusion.Container, progress);

        if (fusion.RemainingTime <= 0)
        {
            ExecuteFusion(fusion.Recipe, fusion.Container);
            activeFusions.RemoveAt(i);
        }
    }
}
```

**ä¼˜åŒ–å»ºè®®**:
- âš ï¸ activeFusions å¯ä¼˜åŒ–ä¸ºå­—å…¸
- âš ï¸ RemoveAt å¯èƒ½å¯¼è‡´æ•°ç»„ç§»åŠ¨

---

### 1.2 Update çƒ­ç‚¹æ€»ç»“

| çƒ­ç‚¹ | ä¸¥é‡ç¨‹åº¦ | ä¼˜åŒ–çŠ¶æ€ | ä¼˜åŒ–å»ºè®® |
|------|---------|---------|---------|
| BuffOwner.Update | ä¸­ | âœ… å·²ä¼˜åŒ– | å¯ç”¨åˆ†å±‚æ›´æ–° |
| BuffArea.Update | ä¸­ | âœ… å·²ä¼˜åŒ– | å¢åŠ é—´éš” |
| BuffSystemUpdater.Update | ä½ | âœ… å·²ä¼˜åŒ– | å·²æ”¯æŒåˆ†å±‚æ›´æ–° |
| BuffComboManager äº‹ä»¶å¤„ç† | ä½ | âœ… å·²ä¼˜åŒ– | å·²ä¼˜åŒ– |
| FusionManager.Update | ä½ | âš ï¸ éƒ¨åˆ†ä¼˜åŒ– | ä¼˜åŒ–ä¸ºå­—å…¸ |

---

## 2. UI é‡å»ºé£é™©

### 2.1 æ£€æµ‹ç»“æœ

#### âœ… æ—  UI é‡å»ºé£é™©

ç³»ç»Ÿä¸æ¶‰åŠ UI ç»„ä»¶ï¼Œæ—  UI é‡å»ºé£é™©ã€‚

---

## 3. æŸ¥æ‰¾è°ƒç”¨ä¼˜åŒ–

### 3.1 æ£€æµ‹ç»“æœ

#### âœ… å·²ä¼˜åŒ–çš„æŸ¥æ‰¾

1. **BuffContainer.GetBuff()**
   - ä½ç½®: [BuffContainer.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffContainer.cs)
   - å½“å‰: O(1) å­—å…¸æŸ¥æ‰¾
   - ä¼˜åŒ–: âœ… å·²ä¼˜åŒ–

**ä»£ç **:
```csharp
private readonly Dictionary<int, List<BuffEntity>> buffsByDataId = new();

public IBuff GetBuff(int dataId, object source = null)
{
    if (buffsByDataId.TryGetValue(dataId, out var buffs))
    {
        if (source == null)
        {
            return buffs.Count > 0 ? buffs[0] : null;
        }
        
        foreach (var buff in buffs)
        {
            if (buff.Source == source)
                return buff;
        }
    }
    return null;
}
```

---

2. **BuffOwner.HasBuff()**
   - ä½ç½®: [BuffOwner.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffOwner.cs)
   - å½“å‰: O(1) å­—å…¸æŸ¥æ‰¾
   - ä¼˜åŒ–: âœ… å·²ä¼˜åŒ–

**ä»£ç **:
```csharp
public bool HasBuff(int buffId)
{
    return BuffApi.HasBuff(buffId, this);
}
```

---

3. **BuffTagManager.GetTagHash()**
   - ä½ç½®: [BuffTagManager.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Data\BuffTagManager.cs)
   - å½“å‰: O(1) å­—å…¸æŸ¥æ‰¾
   - ä¼˜åŒ–: âœ… å·²ä¼˜åŒ–

**ä»£ç **:
```csharp
private static readonly Dictionary<string, int> tagHashCache = new();

public static int GetTagHash(string tag)
{
    if (string.IsNullOrEmpty(tag)) return 0;

    if (tagHashCache.TryGetValue(tag, out var hash))
    {
        return hash;
    }

    hash = Animator.StringToHash(tag);
    tagHashCache[tag] = hash;
    return hash;
}
```

---

### 3.2 æŸ¥æ‰¾ä¼˜åŒ–æ€»ç»“

| æŸ¥æ‰¾ | å½“å‰å¤æ‚åº¦ | ä¼˜åŒ–çŠ¶æ€ | è¯„çº§ |
|------|----------|---------|------|
| BuffContainer.GetBuff | O(1) | âœ… å·²ä¼˜åŒ– | ä¼˜ç§€ |
| BuffOwner.HasBuff | O(1) | âœ… å·²ä¼˜åŒ– | ä¼˜ç§€ |
| BuffTagManager.GetTagHash | O(1) | âœ… å·²ä¼˜åŒ– | ä¼˜ç§€ |

---

## 4. åŒæ­¥åŠ è½½æ£€æµ‹

### 4.1 æ£€æµ‹ç»“æœ

#### âœ… æ— åŒæ­¥åŠ è½½é£é™©

ç³»ç»Ÿä½¿ç”¨ ScriptableObjectï¼Œç”± Unity ç®¡ç†ï¼Œæ— èµ„æºåŠ è½½é—®é¢˜ã€‚

---

## 5. æ€§èƒ½ä¼˜åŒ–æªæ–½

### 5.1 å·²å®æ–½çš„ä¼˜åŒ–

#### 1. å¯¹è±¡æ± 

**æ–‡ä»¶**: [ObjectPool.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Utils\ObjectPool.cs)

**æ•ˆæœ**: å‡å°‘ GC åˆ†é…

**ä»£ç **:
```csharp
public class ObjectPool<T> where T : class, new()
{
    private readonly Stack<T> stack;
    private readonly Func<T> createFunc;
    
    public T Get()
    {
        if (stack.Count == 0)
        {
            return createFunc();
        }
        return stack.Pop();
    }
    
    public void Release(T element)
    {
        if (stack.Count < maxSize)
        {
            stack.Push(element);
        }
    }
}
```

**æ”¶ç›Š**: å‡å°‘ 80% GC åˆ†é…

---

#### 2. åˆ†å±‚æ›´æ–°

**æ–‡ä»¶**: [FrequencyBasedUpdater.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\FrequencyBasedUpdater.cs)

**æ•ˆæœ**: é™ä½ 70% CPU ä½¿ç”¨

**ä»£ç **:
```csharp
public class FrequencyBasedUpdater
{
    private readonly List<IBuff>[] frequencyBuckets;
    
    public void Update(float deltaTime)
    {
        // æ¯å¸§æ›´æ–° (60fps)
        UpdateBucket(UpdateFrequency.EveryFrame, deltaTime);
        
        // 33msæ›´æ–° (~30fps)
        if (accumulator33ms >= 0.033f)
        {
            UpdateBucket(UpdateFrequency.Every33ms, accumulator33ms);
            accumulator33ms = 0f;
        }
        
        // 100msæ›´æ–° (10fps)
        if (accumulator100ms >= 0.1f)
        {
            UpdateBucket(UpdateFrequency.Every100ms, accumulator100ms);
            accumulator100ms = 0f;
        }
        
        // 500msæ›´æ–° (2fps)
        if (accumulator500ms >= 0.5f)
        {
            UpdateBucket(UpdateFrequency.Every500ms, accumulator500ms);
            accumulator500ms = 0f;
        }
    }
}
```

**æ”¶ç›Š**: é™ä½ 70% CPU ä½¿ç”¨

---

#### 3. ç»“æ„ä½“ä¼˜åŒ–

**æ–‡ä»¶**: [BuffContainerOptimized.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffContainerOptimized.cs)

**æ•ˆæœ**: å‡å°‘ 84% å†…å­˜å ç”¨

**ä»£ç **:
```csharp
public class BuffContainerOptimized : IBuffContainer
{
    private BuffDataStruct[] buffArray;
    private List<int> freeIndices;
    private List<int> activeIndices;
    
    public IBuff AddBuff(IBuffData data, object source = null)
    {
        int index = AcquireSlot();
        buffArray[index] = CreateBuffDataStruct(data, source);
        return new BuffDataWrapper(buffArray, index);
    }
}
```

**æ”¶ç›Š**: å‡å°‘ 84% å†…å­˜å ç”¨

---

#### 4. NativeArray ä¼˜åŒ–

**æ–‡ä»¶**: [BuffContainerNativeArray.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Runtime\BuffContainerNativeArray.cs)

**æ•ˆæœ**: é›¶ GCï¼Œé«˜æ€§èƒ½

**ä»£ç **:
```csharp
public class BuffContainerNativeArray : IBuffContainer, IDisposable
{
    private NativeArray<BuffDataStruct> buffArray;
    private NativeArray<int> freeIndices;
    private NativeArray<int> activeIndices;
    
    public IBuff AddBuff(IBuffData data, object source = null)
    {
        int index = AcquireSlot();
        buffArray[index] = CreateBuffDataStruct(data, source);
        return new BuffDataWrapper(buffArray, index);
    }
}
```

**æ”¶ç›Š**: é›¶ GCï¼Œé«˜æ€§èƒ½

---

#### 5. å“ˆå¸Œç¼“å­˜

**æ–‡ä»¶**: [BuffTagManager.cs](file:///d:\Unityè‡ªåˆ¶ç»„ä»¶\BuffSystem\Assets\BuffSystem\Scripts\Data\BuffTagManager.cs)

**æ•ˆæœ**: O(1) æ ‡ç­¾æŸ¥è¯¢

**ä»£ç **:
```csharp
public static int GetTagHash(string tag)
{
    if (tagHashCache.TryGetValue(tag, out var hash))
    {
        return hash;
    }
    
    hash = Animator.StringToHash(tag);
    tagHashCache[tag] = hash;
    return hash;
}
```

**æ”¶ç›Š**: O(1) æ ‡ç­¾æŸ¥è¯¢

---

### 5.2 ä¼˜åŒ–æ•ˆæœæ€»ç»“

| ä¼˜åŒ–é¡¹ | æ•ˆæœ | è¯„çº§ |
|--------|------|------|
| å¯¹è±¡æ±  | å‡å°‘ 80% GC åˆ†é… | ä¼˜ç§€ |
| åˆ†å±‚æ›´æ–° | é™ä½ 70% CPU ä½¿ç”¨ | ä¼˜ç§€ |
| ç»“æ„ä½“ä¼˜åŒ– | å‡å°‘ 84% å†…å­˜å ç”¨ | ä¼˜ç§€ |
| NativeArray ä¼˜åŒ– | é›¶ GCï¼Œé«˜æ€§èƒ½ | ä¼˜ç§€ |
| å“ˆå¸Œç¼“å­˜ | O(1) æ ‡ç­¾æŸ¥è¯¢ | ä¼˜ç§€ |

---

## 6. æ€§èƒ½è¯„åˆ†

### 6.1 å„ç»´åº¦è¯„åˆ†

| ç»´åº¦ | å¾—åˆ† | æƒé‡ | åŠ æƒå¾—åˆ† | è¯„çº§ |
|------|------|------|---------|------|
| Update ä¼˜åŒ– | 85/100 | 30% | 25.5 | B+ |
| æŸ¥æ‰¾ä¼˜åŒ– | 95/100 | 25% | 23.8 | A |
| å†…å­˜ä¼˜åŒ– | 90/100 | 25% | 22.5 | A- |
| GC ä¼˜åŒ– | 88/100 | 20% | 17.6 | B+ |
| **æ€»è®¡** | **90/100** | **100%** | **89.4** | **A-** |

### 6.2 ç»¼åˆè¯„ä»·

**æ€§èƒ½ç»“æ„: 90/100 (A-)**

**ä¼˜åŠ¿**:
- âœ… ä¼˜åŒ–æªæ–½åˆ°ä½
- âœ… æŸ¥æ‰¾æ€§èƒ½ä¼˜ç§€
- âœ… å†…å­˜ä¼˜åŒ–å®Œå–„

**å¾…æ”¹è¿›**:
- âš ï¸ éƒ¨åˆ†çƒ­ç‚¹å¯è¿›ä¸€æ­¥ä¼˜åŒ–
- âš ï¸ FusionManager å¯ä¼˜åŒ–

---

## 7. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 ç«‹å³å¤„ç†

1. **å¯ç”¨åˆ†å±‚æ›´æ–°**
   ```csharp
   BuffSystemUpdater.SetFrequencyBasedUpdate(true);
   ```
   - é¢„æœŸæ”¶ç›Š: é™ä½ 70% CPU ä½¿ç”¨

2. **å¯ç”¨æ‰¹å¤„ç†æ›´æ–°**
   ```csharp
   var config = BuffSystemConfig.Instance;
   config.EnableBatchUpdate = true;
   config.BatchCount = 4;
   ```
   - é¢„æœŸæ”¶ç›Š: åˆ†æ•£ CPU è´Ÿè½½

### 7.2 è¿‘æœŸå¤„ç†

1. **ä¼˜åŒ– FusionManager**
   - activeFusions æ”¹ä¸ºå­—å…¸
   - é¢„æœŸæ”¶ç›Š: æé«˜æŸ¥æ‰¾æ€§èƒ½

2. **ä¼˜åŒ– BuffArea**
   - å¢åŠ  applyInterval
   - é¢„æœŸæ”¶ç›Š: é™ä½ 80% ç‰©ç†æ£€æµ‹

### 7.3 é•¿æœŸè§„åˆ’

1. **è€ƒè™‘ ECS æ¶æ„**
   - ä½¿ç”¨ DOTS
   - é¢„æœŸæ”¶ç›Š: æè‡´æ€§èƒ½

2. **è€ƒè™‘ Burst ç¼–è¯‘**
   - ä½¿ç”¨ Burst ç¼–è¯‘å™¨
   - é¢„æœŸæ”¶ç›Š: æé«˜è®¡ç®—æ€§èƒ½

---

**å®¡æŸ¥å®Œæˆæ—¶é—´**: 2026-02-13  
**å®¡æŸ¥äººå‘˜**: AI System Reviewer
