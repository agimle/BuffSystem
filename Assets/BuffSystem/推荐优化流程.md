# BuffSystem æ¨èä¼˜åŒ–æµç¨‹

**æ–‡æ¡£æ—¥æœŸ**: 2026-02-10  
**é€‚ç”¨ç‰ˆæœ¬**: åŸºäºä»£ç å®¡æŸ¥æŠ¥å‘Š v1.0  
**ç›®æ ‡**: ç³»ç»Ÿæ€§ä¼˜åŒ–BuffSystemä»£ç è´¨é‡

---

## ä¸€ã€ä¼˜åŒ–å‰å‡†å¤‡

### 1.1 ç¯å¢ƒæ£€æŸ¥æ¸…å•

- [ ] Unityç‰ˆæœ¬ç¡®è®¤ï¼ˆå»ºè®®ä½¿ç”¨2021.3 LTSæˆ–æ›´é«˜ï¼‰
- [ ] å¤‡ä»½å½“å‰é¡¹ç›®ï¼ˆGitæäº¤æˆ–å‹ç¼©å¤‡ä»½ï¼‰
- [ ] å…³é—­Unityç¼–è¾‘å™¨ï¼ˆé¿å…æ–‡ä»¶å ç”¨å†²çªï¼‰
- [ ] ç¡®è®¤æ‰€æœ‰BuffDataSOé…ç½®å·²ä¿å­˜

### 1.2 æµ‹è¯•ç¯å¢ƒæ­å»º

```csharp
// å»ºè®®åˆ›å»ºä¸€ä¸ªæµ‹è¯•åœºæ™¯éªŒè¯ä¼˜åŒ–æ•ˆæœ
// Assets/Tests/BuffSystemTestScene.unity
```

---

## äºŒã€ä¼˜åŒ–é˜¶æ®µï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### ğŸ”´ é˜¶æ®µä¸€ï¼šé«˜ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆå¿…é¡»å®Œæˆï¼‰

#### æ­¥éª¤ 1.1: ä¼˜åŒ– AllBuffs å±æ€§å®ç°

**ç›®æ ‡æ–‡ä»¶**: `Scripts/Runtime/BuffContainer.cs`  
**è¡Œå·**: 35-45  
**é¢„ä¼°è€—æ—¶**: 15åˆ†é’Ÿ

**é—®é¢˜æè¿°**:
```csharp
// å½“å‰å®ç° - æ¯æ¬¡è°ƒç”¨éƒ½æ¸…ç©ºé‡å»ºç¼“å­˜
public IReadOnlyCollection<IBuff> AllBuffs
{
    get
    {
        buffCache.Clear();
        foreach (var buff in buffByInstanceId.Values)
        {
            buffCache.Add(buff);
        }
        return buffCache;
    }
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```csharp
// ä¼˜åŒ–å - è¿”å›åªè¯»è§†å›¾ï¼Œé¿å…é‡å¤æ„å»º
private IReadOnlyCollection<IBuff> allBuffsReadOnly;

public IReadOnlyCollection<IBuff> AllBuffs
{
    get
    {
        if (allBuffsReadOnly == null)
        {
            allBuffsReadOnly = buffByInstanceId.Values.ToList().AsReadOnly();
        }
        return allBuffsReadOnly;
    }
}

// åœ¨AddBuff/RemoveBuffæ—¶ä½¿ç¼“å­˜å¤±æ•ˆ
private void InvalidateCache()
{
    allBuffsReadOnly = null;
}
```

**éªŒè¯æ–¹æ³•**:
1. è¿è¡Œæµ‹è¯•åœºæ™¯
2. é¢‘ç¹è°ƒç”¨ `BuffContainer.AllBuffs`
3. ä½¿ç”¨Unity Profileræ£€æŸ¥GC Alloc

---

#### æ­¥éª¤ 1.2: ä¼˜åŒ– CreateLogic æ€§èƒ½

**ç›®æ ‡æ–‡ä»¶**: `Scripts/Data/BuffDataSO.cs`  
**è¡Œå·**: 85-92  
**é¢„ä¼°è€—æ—¶**: 30åˆ†é’Ÿ

**é—®é¢˜æè¿°**:
```csharp
// å½“å‰å®ç° - æ¯æ¬¡åˆ›å»ºéƒ½è¿›è¡ŒJsonåºåˆ—åŒ–
public IBuffLogic CreateLogic()
{
    string json = JsonUtility.ToJson(buffLogicInstance);
    BuffLogicBase clone = (BuffLogicBase)System.Activator.CreateInstance(buffLogicInstance.GetType());
    JsonUtility.FromJsonOverwrite(json, clone);
    return clone;
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```csharp
// æ–¹æ¡ˆA: ä½¿ç”¨åŸå‹æ¨¡å¼ï¼ˆæ¨èï¼‰
public IBuffLogic CreateLogic()
{
    if (buffLogicInstance == null) return null;
    
    // ä½¿ç”¨MemberwiseCloneè¿›è¡Œæµ…æ‹·è´ï¼Œç„¶åæ·±æ‹·è´å¿…è¦å­—æ®µ
    var clone = (BuffLogicBase)buffLogicInstance.Clone();
    return clone;
}

// åœ¨BuffLogicBaseä¸­æ·»åŠ 
public abstract class BuffLogicBase : IBuffLogic, ICloneable
{
    public object Clone()
    {
        var clone = (BuffLogicBase)MemberwiseClone();
        clone.InitializeInternal(); // é‡ç½®è¿è¡Œæ—¶çŠ¶æ€
        return clone;
    }
    
    protected virtual void InitializeInternal() { }
}
```

**éªŒè¯æ–¹æ³•**:
1. åˆ›å»º100ä¸ªBuffå®ä¾‹
2. æ¯”è¾ƒä¼˜åŒ–å‰åçš„è€—æ—¶ï¼ˆä½¿ç”¨Stopwatchï¼‰

---

#### æ­¥éª¤ 1.3: å®Œå–„ BuffSystemUpdater

**ç›®æ ‡æ–‡ä»¶**: `Scripts/Runtime/BuffSystemUpdater.cs`  
**è¡Œå·**: 82-85  
**é¢„ä¼°è€—æ—¶**: 20åˆ†é’Ÿ

**é—®é¢˜æè¿°**:
```csharp
private void UpdateAllContainers(float deltaTime)
{
    // è¿™é‡Œå¯ä»¥é€šè¿‡BuffOwnerçš„é™æ€åˆ—è¡¨æ¥æ‰¹é‡æ›´æ–°
    // æˆ–è€…è®©æ¯ä¸ªBuffOwnerè‡ªå·±æ›´æ–°
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```csharp
// åœ¨BuffOwnerä¸­æ·»åŠ é™æ€åˆ—è¡¨
public class BuffOwner : MonoBehaviour, IBuffOwner
{
    private static readonly List<BuffOwner> allOwners = new();
    
    private void OnEnable() => allOwners.Add(this);
    private void OnDisable() => allOwners.Remove(this);
    
    internal static void UpdateAll(float deltaTime)
    {
        foreach (var owner in allOwners)
        {
            if (owner != null && owner.gameObject.activeInHierarchy)
            {
                owner.BuffContainer?.Update(deltaTime);
            }
        }
    }
}

// åœ¨BuffSystemUpdaterä¸­
private void UpdateAllContainers(float deltaTime)
{
    BuffOwner.UpdateAll(deltaTime);
}
```

**éªŒè¯æ–¹æ³•**:
1. åˆ›å»ºå¤šä¸ªå¸¦æœ‰BuffOwnerçš„GameObject
2. è§‚å¯Ÿæ˜¯å¦éƒ½èƒ½æ­£ç¡®æ›´æ–°

---

#### æ­¥éª¤ 1.4: ç»Ÿä¸€å‘½åè§„èŒƒ

**ç›®æ ‡æ–‡ä»¶**: å…¨éƒ¨è„šæœ¬æ–‡ä»¶  
**é¢„ä¼°è€—æ—¶**: 20åˆ†é’Ÿ

**é—®é¢˜æè¿°**:
```csharp
// ObjectPool.cs ä½¿ç”¨ä¸‹åˆ’çº¿å‰ç¼€
private readonly Stack<T> _stack;

// BuffContainer.cs ä¸ä½¿ç”¨ä¸‹åˆ’çº¿å‰ç¼€
private readonly Dictionary<int, BuffEntity> buffByInstanceId;
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
ç»Ÿä¸€ä½¿ç”¨ `_camelCase` ä½œä¸ºç§æœ‰å­—æ®µå‘½å

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**:
1. `BuffContainer.cs` - æ‰€æœ‰ç§æœ‰å­—æ®µæ·»åŠ  `_` å‰ç¼€
2. `BuffEntity.cs` - æ‰€æœ‰ç§æœ‰å­—æ®µæ·»åŠ  `_` å‰ç¼€
3. `BuffOwner.cs` - æ‰€æœ‰ç§æœ‰å­—æ®µæ·»åŠ  `_` å‰ç¼€
4. `BuffEventSystem.cs` - æ‰€æœ‰ç§æœ‰å­—æ®µæ·»åŠ  `_` å‰ç¼€
5. `BuffDatabase.cs` - æ‰€æœ‰ç§æœ‰å­—æ®µæ·»åŠ  `_` å‰ç¼€

**æ‰¹é‡æ›¿æ¢ç¤ºä¾‹**:
```csharp
// BuffContainer.cs
private readonly Dictionary<int, BuffEntity> _buffByInstanceId;
private readonly Dictionary<int, List<BuffEntity>> _buffsByDataId;
private readonly Dictionary<object, List<BuffEntity>> _buffsBySource;
private readonly Queue<int> _removalQueue;
private readonly List<IBuff> _buffCache;
```

---

### ğŸŸ¡ é˜¶æ®µäºŒï¼šä¸­ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆå»ºè®®å®Œæˆï¼‰

#### æ­¥éª¤ 2.1: å‡å°‘ LINQ ä½¿ç”¨

**ç›®æ ‡æ–‡ä»¶**: `Scripts/Runtime/BuffContainer.cs`  
**é¢„ä¼°è€—æ—¶**: 25åˆ†é’Ÿ

**é—®é¢˜ä»£ç **:
```csharp
// ä½¿ç”¨LINQåˆ›å»ºæ–°åˆ—è¡¨
foreach (var buff in buffs.ToList())
return buffs.FirstOrDefault();
return Enumerable.Empty<IBuff>();
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```csharp
// ä½¿ç”¨åŸç”Ÿé›†åˆæ“ä½œ
// æ›¿ä»£ ToList()
foreach (var buff in buffs) { }

// æ›¿ä»£ FirstOrDefault()
foreach (var buff in buffs)
{
    if (condition) return buff;
}
return null;

// æ›¿ä»£ Enumerable.Empty<IBuff>()
private static readonly IReadOnlyCollection<IBuff> EmptyBuffs = 
    new List<IBuff>().AsReadOnly();
```

---

#### æ­¥éª¤ 2.2: åŠ å¼ºçº¿ç¨‹å®‰å…¨

**ç›®æ ‡æ–‡ä»¶**: 
- `Scripts/Data/BuffDatabase.cs`
- `Scripts/Runtime/BuffSystemUpdater.cs`  
**é¢„ä¼°è€—æ—¶**: 20åˆ†é’Ÿ

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```csharp
// BuffDatabase.cs
public sealed class BuffDatabase
{
    private static readonly object _lock = new();
    private static BuffDatabase _instance;
    
    public static BuffDatabase Instance
    {
        get
        {
            if (_instance == null)
            {
                lock (_lock)
                {
                    _instance ??= new BuffDatabase();
                }
            }
            return _instance;
        }
    }
}

// BuffSystemUpdater.cs
private static readonly object _createLock = new();

private static void CreateInstance()
{
    lock (_createLock)
    {
        if (instance != null) return;
        
        var go = new GameObject("BuffSystemUpdater");
        instance = go.AddComponent<BuffSystemUpdater>();
        DontDestroyOnLoad(go);
    }
}
```

---

#### æ­¥éª¤ 2.3: å¢åŠ é…ç½®éªŒè¯

**ç›®æ ‡æ–‡ä»¶**: `Scripts/Editor/BuffDataSOEditor.cs`  
**é¢„ä¼°è€—æ—¶**: 30åˆ†é’Ÿ

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```csharp
// åœ¨BuffDataSOEditorä¸­æ·»åŠ éªŒè¯
private void OnEnable()
{
    ValidateBuffData();
}

private void ValidateBuffData()
{
    var allBuffs = BuffDatabase.Instance.GetAllBuffData();
    var idSet = new HashSet<int>();
    
    foreach (var buff in allBuffs)
    {
        if (!idSet.Add(buff.Id))
        {
            Debug.LogError($"Buff IDå†²çª: {buff.Id} è¢«å¤šä¸ªBuffä½¿ç”¨");
        }
    }
}
```

---

#### æ­¥éª¤ 2.4: ä¼˜åŒ– SourceId ç”Ÿæˆ

**ç›®æ ‡æ–‡ä»¶**: `Scripts/Runtime/BuffEntity.cs`  
**é¢„ä¼°è€—æ—¶**: 15åˆ†é’Ÿ

**é—®é¢˜æè¿°**:
```csharp
public int SourceId => source?.GetHashCode() ?? 0;
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```csharp
// ä½¿ç”¨æ›´å¯é çš„å”¯ä¸€æ ‡è¯†
private int _sourceId;

public int SourceId 
{ 
    get
    {
        if (_sourceId == 0 && source != null)
        {
            _sourceId = RuntimeHelpers.GetHashCode(source);
        }
        return _sourceId;
    }
}
```

---

### ğŸŸ¢ é˜¶æ®µä¸‰ï¼šä½ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆå¯é€‰å®Œæˆï¼‰

#### æ­¥éª¤ 3.1: æ·»åŠ æ€§èƒ½ç›‘æ§å·¥å…·

**ç›®æ ‡**: åˆ›å»ºæ€§èƒ½ç›‘æ§ç±»  
**é¢„ä¼°è€—æ—¶**: 40åˆ†é’Ÿ

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```csharp
// Scripts/Utils/BuffSystemProfiler.cs
#if UNITY_EDITOR
public static class BuffSystemProfiler
{
    private static readonly Dictionary<string, long> _timings = new();
    
    public static void BeginSample(string name)
    {
        // å®ç°æ€§èƒ½é‡‡æ ·
    }
    
    public static void EndSample(string name)
    {
        // è®°å½•æ€§èƒ½æ•°æ®
    }
}
#endif
```

---

#### æ­¥éª¤ 3.2: å®Œå–„æ–‡æ¡£æ³¨é‡Š

**ç›®æ ‡æ–‡ä»¶**: å…¨éƒ¨è„šæœ¬æ–‡ä»¶  
**é¢„ä¼°è€—æ—¶**: 60åˆ†é’Ÿ

**ä¼˜åŒ–å†…å®¹**:
- ä¸ºæ‰€æœ‰å…¬å…±APIæ·»åŠ XMLæ³¨é‡Š
- æ·»åŠ ä½¿ç”¨ç¤ºä¾‹
- æ·»åŠ å‚æ•°è¯´æ˜

---

## ä¸‰ã€ä¼˜åŒ–éªŒè¯æµç¨‹

### 3.1 å•å…ƒæµ‹è¯•æ¸…å•

```csharp
// å»ºè®®åˆ›å»ºçš„æµ‹è¯•ç”¨ä¾‹
public class BuffSystemTests
{
    [Test] public void Test_AddBuff() { }
    [Test] public void Test_RemoveBuff() { }
    [Test] public void Test_StackableBuff() { }
    [Test] public void Test_BuffExpiration() { }
    [Test] public void Test_Performance_CreateBuff() { }
    [Test] public void Test_Memory_NoLeak() { }
}
```

### 3.2 æ€§èƒ½åŸºå‡†æµ‹è¯•

| æµ‹è¯•é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | ç›®æ ‡æå‡ |
|--------|--------|--------|----------|
| åˆ›å»º100ä¸ªBuff | X ms | Y ms | >30% |
| AllBuffsè°ƒç”¨1000æ¬¡ | X KB GC | 0 KB GC | 100% |
| æ›´æ–°100ä¸ªBuff | X ms | Y ms | >10% |

### 3.3 å›å½’æµ‹è¯•

- [ ] æ‰€æœ‰ç°æœ‰BuffåŠŸèƒ½æ­£å¸¸
- [ ] ç¼–è¾‘å™¨åŠŸèƒ½æ­£å¸¸
- [ ] åºåˆ—åŒ–/ååºåˆ—åŒ–æ­£å¸¸
- [ ] å¯¹è±¡æ± æ­£å¸¸å·¥ä½œ

---

## å››ã€ä¼˜åŒ–æ—¶é—´è¡¨å»ºè®®

| é˜¶æ®µ | ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | å»ºè®®æ—¥æœŸ |
|------|------|----------|----------|
| é˜¶æ®µä¸€ | æ­¥éª¤1.1 - 1.4 | 1.5å°æ—¶ | Day 1 |
| é˜¶æ®µäºŒ | æ­¥éª¤2.1 - 2.4 | 1.5å°æ—¶ | Day 2 |
| é˜¶æ®µä¸‰ | æ­¥éª¤3.1 - 3.2 | 2å°æ—¶ | Day 3 |
| éªŒè¯ | æµ‹è¯•ä¸ä¿®å¤ | 2å°æ—¶ | Day 4 |

---

## äº”ã€é£é™©æ§åˆ¶

### 5.1 å›æ»šæ–¹æ¡ˆ

å¦‚æœä¼˜åŒ–åå‡ºç°é—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºå›æ»šï¼š
1. å›æ»šé˜¶æ®µä¸‰ä¿®æ”¹
2. å›æ»šé˜¶æ®µäºŒä¿®æ”¹
3. å›æ»šé˜¶æ®µä¸€ä¿®æ”¹ï¼ˆä¿ç•™å‘½åè§„èŒƒï¼‰

### 5.2 å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| åºåˆ—åŒ–å¤±è´¥ | æ£€æŸ¥å­—æ®µå‘½åå˜æ›´æ˜¯å¦å½±å“åºåˆ—åŒ– |
| æ€§èƒ½ä¸‹é™ | ä½¿ç”¨Profilerå®šä½çƒ­ç‚¹ |
| åŠŸèƒ½å¼‚å¸¸ | å¯¹æ¯”ä¼˜åŒ–å‰åçš„ä»£ç é€»è¾‘ |

---

## å…­ã€ä¼˜åŒ–å®Œæˆæ ‡å‡†

### 6.1 ä»£ç æ ‡å‡†

- [ ] æ‰€æœ‰é«˜ä¼˜å…ˆçº§ä¼˜åŒ–å®Œæˆ
- [ ] å‘½åè§„èŒƒç»Ÿä¸€
- [ ] æ— ç¼–è¯‘è­¦å‘Š
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

### 6.2 æ€§èƒ½æ ‡å‡†

- [ ] GC Allocå‡å°‘50%ä»¥ä¸Š
- [ ] Buffåˆ›å»ºæ€§èƒ½æå‡30%ä»¥ä¸Š
- [ ] æ— å†…å­˜æ³„æ¼

### 6.3 åŠŸèƒ½æ ‡å‡†

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ç¼–è¾‘å™¨åŠŸèƒ½æ­£å¸¸
- [ ] è¿è¡Œæ—¶åŠŸèƒ½æ­£å¸¸

---

**æ–‡æ¡£ç»“æŸ**

*å»ºè®®æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µå°±è¿›è¡Œä¸€æ¬¡æµ‹è¯•éªŒè¯ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§*
