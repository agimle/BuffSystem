# ä¿®æ”¹è®°å½•

**ç”Ÿæˆæ—¶é—´**: 2026-02-13
**å®¡æŸ¥å·¥å…·**: csharp-code-review-with-details

---

## ä¿®æ”¹æ¦‚è§ˆ

| é¡¹ç›® | æ•°é‡ |
|------|------|
| æ€»é—®é¢˜æ•° | 58 |
| å·²ä¿®å¤ | 0 |
| å¾…ä¿®å¤ | 58 |
| ä¿®å¤ç‡ | 0% |

---

## ä¿®æ”¹å†å²

### 2026-02-13

**å®¡æŸ¥é˜¶æ®µ**: åˆå§‹å®¡æŸ¥
**ä¿®å¤çŠ¶æ€**: æ— ä¿®å¤ï¼ˆä»…ç”Ÿæˆå®¡æŸ¥æŠ¥å‘Šï¼‰

---

## å¾…ä¿®å¤é—®é¢˜åˆ—è¡¨

### ğŸ”´ é«˜å±é—®é¢˜ (3)

#### 1. BuffSystemManager.cs - è‡ªåŠ¨åˆ›å»º GameObject å¯èƒ½å¯¼è‡´æ„å¤–è¡Œä¸º

**æ–‡ä»¶**: `Core/BuffSystemManager.cs`
**ä½ç½®**: ç¬¬ 56-60 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: é«˜

**å»ºè®®ä¿®æ”¹**:
```csharp
// ä¿®æ”¹å‰
public static BuffSystemManager Instance
{
    get
    {
        if (instance == null) CreateInstance();
        return instance;
    }
}

private static void CreateInstance()
{
    instance = FindFirstObjectByType<BuffSystemManager>();
    if (instance == null)
    {
        var go = new GameObject("BuffSystemManager");
        instance = go.AddComponent<BuffSystemManager>();
        DontDestroyOnLoad(go);
    }
}

// ä¿®æ”¹å
public static BuffSystemManager Instance
{
    get
    {
        if (instance == null)
        {
            instance = FindFirstObjectByType<BuffSystemManager>();
            if (instance == null)
            {
                Debug.LogWarning("[BuffSystemManager] Instance not found. Call Initialize() first.");
                return null;
            }
        }
        return instance;
    }
}

public static void Initialize()
{
    if (instance == null)
    {
        var go = new GameObject("BuffSystemManager");
        instance = go.AddComponent<BuffSystemManager>();
        DontDestroyOnLoad(go);
    }
}
```

---

#### 2. BuffContainer.cs - HandleDependencyRemoval åˆ›å»ºä¸´æ—¶åˆ—è¡¨

**æ–‡ä»¶**: `Runtime/BuffContainer.cs`
**ä½ç½®**: ç¬¬ 448-462 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: é«˜

**å»ºè®®ä¿®æ”¹**:
```csharp
// åœ¨ BuffContainer ç±»ä¸­æ·»åŠ å¯¹è±¡æ± 
private readonly ObjectPool<List<BuffEntity>> buffListPool;

public BuffContainer(IBuffOwner owner)
{
    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
    
    // åˆå§‹åŒ–åˆ—è¡¨å¯¹è±¡æ± 
    buffListPool = new ObjectPool<List<BuffEntity>>(
        createFunc: () => new List<BuffEntity>(),
        actionOnGet: list => list.Clear(),
        actionOnRelease: list => list.Clear(),
        defaultCapacity: 4,
        maxSize: 16
    );
}

private void HandleDependencyRemoval(int removedBuffId)
{
    // ä»å¯¹è±¡æ± è·å–åˆ—è¡¨
    var buffsToRemove = buffListPool.Get();
    
    try
    {
        foreach (var buff in buffByInstanceId.Values)
        {
            if (buff.Data is BuffDataSO buffDataSO && buffDataSO.DependBuffIds.Contains(removedBuffId))
            {
                buffsToRemove.Add(buff);
            }
        }
        
        foreach (var buff in buffsToRemove)
        {
            if (Data.BuffSystemConfig.Instance.EnableDebugLog)
            {
                Debug.Log($"[BuffContainer] Buff {buff.Name} å› ä¾èµ–çš„Buff {removedBuffId} è¢«ç§»é™¤è€Œè‡ªåŠ¨ç§»é™¤");
            }
            RemoveBuff(buff);
        }
    }
    finally
    {
        // å½’è¿˜åˆ—è¡¨åˆ°å¯¹è±¡æ± 
        buffListPool.Release(buffsToRemove);
    }
}
```

---

#### 3. BuffSystemUpdater.cs - åŒé‡æ£€æŸ¥é”å®šç¼ºå°‘ volatile

**æ–‡ä»¶**: `Runtime/BuffSystemUpdater.cs`
**ä½ç½®**: ç¬¬ 82-95 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: é«˜

**å»ºè®®ä¿®æ”¹**:
```csharp
// ä¿®æ”¹å‰
private static BuffSystemUpdater instance;
private static readonly object instanceLock = new();

public static BuffSystemUpdater Instance
{
    get
    {
        if (instance == null)
        {
            CreateInstance();
        }
        return instance;
    }
}

private static void CreateInstance()
{
    if (instance != null) return;

    lock (instanceLock)
    {
        if (instance != null) return;

        var go = new GameObject("BuffSystemUpdater");
        instance = go.AddComponent<BuffSystemUpdater>();
        DontDestroyOnLoad(go);
    }
}

// ä¿®æ”¹å - ä½¿ç”¨ Lazy<T>
private static readonly Lazy<BuffSystemUpdater> lazyInstance = 
    new Lazy<BuffSystemUpdater>(() => 
    {
        var go = new GameObject("BuffSystemUpdater");
        var instance = go.AddComponent<BuffSystemUpdater>();
        DontDestroyOnLoad(go);
        return instance;
    });

public static BuffSystemUpdater Instance => lazyInstance.Value;
```

---

### ğŸŸ  ä¸­å±é—®é¢˜ (12)

#### 1. BuffApi.cs - GetBuffsByTagNonAlloc å¼•ç”¨ä¸å­˜åœ¨çš„æ–¹æ³•

**æ–‡ä»¶**: `Core/BuffApi.cs`
**ä½ç½®**: ç¬¬ 337-341 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
```csharp
// ä¿®æ”¹å‰
public static void GetBuffsByTagNonAlloc(string tag, IBuffOwner target, List<IBuff> result)
{
    target?.BuffContainer?.AllBuffs.FilterByTagNonAlloc(tag, result);
}

// ä¿®æ”¹å
public static void GetBuffsByTagNonAlloc(string tag, IBuffOwner target, List<IBuff> result)
{
    if (target?.BuffContainer == null || string.IsNullOrEmpty(tag))
    {
        result?.Clear();
        return;
    }

    result?.Clear();
    foreach (var buff in target.BuffContainer.AllBuffs)
    {
        if (buff.Data.Tags.Contains(tag))
        {
            result.Add(buff);
        }
    }
}
```

---

#### 2. BuffDataSO.cs - Tags å±æ€§æ¯æ¬¡åˆ›å»ºæ–°åˆ—è¡¨

**æ–‡ä»¶**: `Data/BuffDataSO.cs`
**ä½ç½®**: ç¬¬ 241-252 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
```csharp
// æ·»åŠ ç¼“å­˜å­—æ®µ
private IReadOnlyList<string> cachedTags;
private bool tagsCacheValid = false;

public IReadOnlyList<string> Tags
{
    get
    {
        if (tagsCacheValid)
        {
            return cachedTags;
        }

        if (tags.Count == 0)
        {
            cachedTags = System.Array.Empty<string>();
        }
        else
        {
            var result = new string[tags.Count];
            for (int i = 0; i < tags.Count; i++)
            {
                result[i] = tags[i].TagName;
            }
            cachedTags = result;
        }

        tagsCacheValid = true;
        return cachedTags;
    }
}

private void OnValidate()
{
    // ... å…¶ä»–éªŒè¯ä»£ç 
    
    // æ ‡è®°ç¼“å­˜å¤±æ•ˆ
    tagsCacheValid = false;
}
```

---

#### 3. BuffEntity.cs - sourceId ä½¿ç”¨ä¸ç¨³å®šçš„å“ˆå¸Œ

**æ–‡ä»¶**: `Runtime/BuffEntity.cs`
**ä½ç½®**: ç¬¬ 97 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
```csharp
// æ·»åŠ ä¸€ä¸ªç¨³å®šçš„ ID ç”Ÿæˆå™¨
public static class SourceIdGenerator
{
    private static int nextId = 1;
    private static readonly Dictionary<object, int> sourceIdMap = new();

    public static int GetSourceId(object source)
    {
        if (source == null) return 0;

        lock (sourceIdMap)
        {
            if (!sourceIdMap.TryGetValue(source, out int id))
            {
                id = nextId++;
                sourceIdMap[source] = id;
            }
            return id;
        }
    }

    public static void RemoveSourceId(object source)
    {
        if (source == null) return;

        lock (sourceIdMap)
        {
            sourceIdMap.Remove(source);
        }
    }
}

// åœ¨ BuffEntity ä¸­ä½¿ç”¨
sourceId = SourceIdGenerator.GetSourceId(source);
```

---

#### 4. BuffContainer.cs - CreateNewBuff æ–¹æ³•è¿‡é•¿

**æ–‡ä»¶**: `Runtime/BuffContainer.cs`
**ä½ç½®**: ç¬¬ 523-623 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
å°†æ–¹æ³•æ‹†åˆ†ä¸ºå¤šä¸ªå°æ–¹æ³•ï¼š
- `ApplyModifiers`
- `InitializeBuff`
- `StoreBuff`
- `TriggerBuffEvents`

---

#### 5. BuffOwner.cs - RemoveBuffsByTag åˆ›å»ºä¸´æ—¶åˆ—è¡¨

**æ–‡ä»¶**: `Runtime/BuffOwner.cs`
**ä½ç½®**: ç¬¬ 418-429 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
ä½¿ç”¨å¯¹è±¡æ± æˆ–ç›´æ¥åœ¨å¾ªç¯ä¸­ç§»é™¤ã€‚

---

#### 6. BuffOwner.cs - OnGUI æ¯å¸§æ‰§è¡Œå¯èƒ½å½±å“æ€§èƒ½

**æ–‡ä»¶**: `Runtime/BuffOwner.cs`
**ä½ç½®**: ç¬¬ 532-566 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
```csharp
#if UNITY_EDITOR
private void OnGUI()
{
    if (!showDebugInfo || buffContainer == null) return;
    
    // ... è°ƒè¯•ä»£ç 
}
#endif
```

---

#### 7. BuffSaveManager.cs - FindOwnerById éå†æ‰€æœ‰ Owner

**æ–‡ä»¶**: `Runtime/BuffSaveManager.cs`
**ä½ç½®**: ç¬¬ 285-295 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
åœ¨ `BuffOwner` ä¸­æ·»åŠ é™æ€å­—å…¸ç´¢å¼•ã€‚

---

#### 8. BuffComboManager.cs - ExecuteEffect ä½¿ç”¨ switch

**æ–‡ä»¶**: `Advanced/Combo/BuffComboManager.cs`
**ä½ç½®**: ç¬¬ 326-377 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
ä½¿ç”¨å­—å…¸æ˜ å°„æˆ–ç­–ç•¥æ¨¡å¼ã€‚

---

#### 9. FusionManager.cs - activeFusions éå†å¯èƒ½å½±å“æ€§èƒ½

**æ–‡ä»¶**: `Advanced/Fusion/FusionManager.cs`
**ä½ç½®**: ç¬¬ 155-170 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
è€ƒè™‘åˆ†æ‰¹å¤„ç†ã€‚

---

#### 10. TransmissionManager.cs - é€’å½’è°ƒç”¨å¯èƒ½å¯¼è‡´æ ˆæº¢å‡º

**æ–‡ä»¶**: `Advanced/Transmission/TransmissionManager.cs`
**ä½ç½®**: ç¬¬ 62-75 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
æ”¹ä¸ºè¿­ä»£å®ç°æˆ–æ·»åŠ æ·±åº¦é™åˆ¶ã€‚

---

#### 11. BuffGroup.cs - RemoveWeakestBuff éå†æ‰€æœ‰ Buff

**æ–‡ä»¶**: `Groups/BuffGroup.cs`
**ä½ç½®**: ç¬¬ 119-135 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
ç»´æŠ¤æœ€å°å †æˆ–ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚

---

#### 12. DelayEffect.cs - Cancel å–æ¶ˆæ‰€æœ‰å»¶è¿Ÿæ•ˆæœ

**æ–‡ä»¶**: `Effects/Core/DelayEffect.cs`
**ä½ç½®**: ç¬¬ 70-75 è¡Œ
**çŠ¶æ€**: â³ å¾…ä¿®å¤
**ä¼˜å…ˆçº§**: ä¸­

**å»ºè®®ä¿®æ”¹**:
è€ƒè™‘åªå–æ¶ˆæœªè§¦å‘çš„æ•ˆæœã€‚

---

### ğŸŸ¡ ä½å±é—®é¢˜ (28)

è¯¦è§ [é£é™©é—®é¢˜](./03_é£é™©é—®é¢˜.md) æ–‡æ¡£ã€‚

---

### ğŸ”µ å»ºè®®é—®é¢˜ (15)

è¯¦è§ [é£é™©é—®é¢˜](./03_é£é™©é—®é¢˜.md) æ–‡æ¡£ã€‚

---

## ä¿®å¤è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šé«˜å±é—®é¢˜ä¿®å¤

**é¢„è®¡æ—¶é—´**: 2-3 å¤©
**ä¿®å¤å†…å®¹**:
1. BuffSystemManager.cs - è‡ªåŠ¨åˆ›å»º GameObject ä¿®å¤
2. BuffContainer.cs - HandleDependencyRemoval ä¿®å¤
3. BuffSystemUpdater.cs - åŒé‡æ£€æŸ¥é”å®šä¿®å¤

### ç¬¬äºŒé˜¶æ®µï¼šä¸­å±é—®é¢˜ä¿®å¤

**é¢„è®¡æ—¶é—´**: 5-7 å¤©
**ä¿®å¤å†…å®¹**:
1. BuffApi.cs - GetBuffsByTagNonAlloc ä¿®å¤
2. BuffDataSO.cs - Tags å±æ€§ç¼“å­˜ä¿®å¤
3. BuffEntity.cs - sourceId ç¨³å®šæ€§ä¿®å¤
4. BuffContainer.cs - CreateNewBuff æ‹†åˆ†
5. BuffOwner.cs - RemoveBuffsByTag ä¼˜åŒ–
6. BuffOwner.cs - OnGUI æ¡ä»¶ç¼–è¯‘
7. BuffSaveManager.cs - FindOwnerById ä¼˜åŒ–
8. BuffComboManager.cs - ExecuteEffect é‡æ„
9. FusionManager.cs - activeFusions ä¼˜åŒ–
10. TransmissionManager.cs - é€’å½’æ”¹ä¸ºè¿­ä»£
11. BuffGroup.cs - RemoveWeakestBuff ä¼˜åŒ–
12. DelayEffect.cs - Cancel é€»è¾‘ä¿®å¤

### ç¬¬ä¸‰é˜¶æ®µï¼šä½å±é—®é¢˜ä¿®å¤

**é¢„è®¡æ—¶é—´**: 7-10 å¤©
**ä¿®å¤å†…å®¹**:
1. ä¿®å¤æ‰€æœ‰ä½å±é—®é¢˜

### ç¬¬å››é˜¶æ®µï¼šå»ºè®®é—®é¢˜å®æ–½

**é¢„è®¡æ—¶é—´**: æŒ‰éœ€å®æ–½
**ä¿®å¤å†…å®¹**:
1. æ ¹æ®å®é™…éœ€æ±‚å®æ–½å»ºè®®é—®é¢˜

---

## ä¿®å¤è®°å½•æ¨¡æ¿

### ä¿®å¤è®°å½•ç¤ºä¾‹

**æ—¥æœŸ**: YYYY-MM-DD
**ä¿®å¤äºº**: [å§“å]
**é—®é¢˜ç¼–å·**: [ç¼–å·]
**é—®é¢˜æè¿°**: [é—®é¢˜æè¿°]
**ä¿®å¤å‰**: [ä»£ç ç‰‡æ®µ]
**ä¿®å¤å**: [ä»£ç ç‰‡æ®µ]
**æµ‹è¯•ç»“æœ**: [æµ‹è¯•ç»“æœ]
**å¤‡æ³¨**: [å¤‡æ³¨]

---

**ä¿®æ”¹è®°å½•ç”Ÿæˆå®Œæˆæ—¶é—´**: 2026-02-13
