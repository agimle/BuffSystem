# 依赖图谱

**生成时间**: 2026-02-13
**分析范围**: BuffSystem 完整依赖关系

---

## 核心依赖图

### Level 1: 基础接口层

```
IBuff (Core/IBuff.cs)
├─ 属性: InstanceId, DataId, Name, CurrentStack, MaxStack, Duration, etc.
├─ 方法: AddStack, RemoveStack, RefreshDuration, SetDuration, MarkForRemoval, Reset
└─ 泛型: IBuff<TSource>

IBuffData (Core/IBuffData.cs)
├─ 属性: Id, Name, Description, EffectType, IsUnique, StackMode, etc.
├─ 方法: HasTag, CreateLogic
└─ 枚举: BuffEffectType, BuffStackMode, BuffRemoveMode, MutexPriority

IBuffLogic (Core/IBuffLogic.cs)
├─ 属性: Buff
├─ 方法: Initialize, Dispose
└─ 子接口: IBuffStart, IBuffAcquire, IBuffLogicUpdate, IBuffVisualUpdate, etc.

IEffect (Core/IEffect.cs)
└─ 方法: Execute, Cancel

IBuffOwner (Core/IBuffOwner.cs)
├─ 属性: OwnerId, OwnerName, BuffContainer, LocalEvents, ImmuneTags
├─ 方法: OnBuffEvent, IsImmuneTo, IsImmuneToTag
└─ 事件: BuffEventType

IBuffCondition (Core/IBuffCondition.cs)
├─ 方法: Check
└─ 属性: Description

IBuffSerializable (Core/IBuffSerializable.cs)
└─ 方法: Serialize, Deserialize

BuffEventType (Core/BuffEventType.cs)
└─ 枚举: Added, Removed, StackChanged, Refreshed, Expired, Cleared
```

### Level 2: 基类实现层

```
EffectBase (Core/EffectBase.cs)
├─ 实现: IEffect
├─ 方法: Execute, Cancel (abstract)
└─ 辅助: TryGetOwnerComponent, SendEvent

BuffLogicBase (Core/BuffLogicBase.cs)
├─ 实现: IBuffLogic, ICloneable, IBuffSerializable
├─ 属性: Buff, Owner, Source, CurrentStack
├─ 方法: Clone, Initialize, Dispose, Serialize, Deserialize
└─ 辅助: GetSource, TryGetSource, TryGetOwnerComponent, SendEvent

EffectBasedBuffLogic (Core/EffectBasedBuffLogic.cs)
├─ 继承: BuffLogicBase
├─ 实现: IBuffAcquire, IBuffRemove, IBuffRefresh, etc.
├─ 字段: onAcquireEffects, onRemoveEffects, onRefreshEffects, etc.
└─ 方法: OnAcquire, OnRemove, OnRefresh, etc.

ConditionGroup (Core/ConditionGroup.cs)
├─ 实现: IBuffCondition
├─ 枚举: ConditionCombineType (And, Or, Not)
├─ 字段: combineType, conditions
└─ 方法: Check, AddCondition, RemoveCondition, ClearConditions
```

### Level 3: 数据层

```
BuffTag (Data/BuffTag.cs)
├─ 结构体
├─ 字段: tagName, tagHash
└─ 方法: Equals, GetHashCode

BuffTagManager (Data/BuffTagManager.cs)
├─ 静态类
├─ 字段: TagHashCache (Dictionary<string, int>)
└─ 方法: GetTagHash, PreCacheTags, ClearCache

BuffSystemConfig (Data/BuffSystemConfig.cs)
├─ ScriptableObject
├─ 字段: defaultPoolCapacity, maxPoolSize, updateMode, etc.
└─ 单例: Instance

BuffDataSO (Data/BuffDataSO.cs)
├─ ScriptableObject
├─ 实现: IBuffData
├─ 字段: id, buffName, description, effectType, etc.
├─ 方法: HasTag, BelongsToGroup, GetGroupConfig, CreateLogic
└─ 支持: 模板继承

BuffDatabase (Data/BuffDatabase.cs)
├─ 单例: Instance
├─ 字段: idToData, nameToId, readonlyIdToData, readonlyNameToId
└─ 方法: Initialize, Reload, GetBuffData, ContainsBuff, GetAllBuffData
```

### Level 4: 工具层

```
ObjectPool<T> (Utils/ObjectPool.cs)
├─ 泛型类
├─ 字段: stack, createFunc, actionOnGet, actionOnRelease, etc.
└─ 方法: Get, Release, Clear

BuffQueryHelper (Utils/BuffQueryHelper.cs)
├─ 静态类
└─ 方法: FilterByTag, FilterBySource, etc.
```

### Level 5: 策略层

```
IStackStrategy (Strategy/BuffStrategy.cs)
├─ 接口
├─ 方法: HandleStack, ShouldRefresh
└─ 实现: StackableStrategy, NonStackableStrategy, IndependentStrategy

IRefreshStrategy (Strategy/BuffStrategy.cs)
├─ 接口
├─ 方法: CanRefresh, Refresh
└─ 实现: RefreshableStrategy, NonRefreshableStrategy

IRemoveStrategy (Strategy/BuffStrategy.cs)
├─ 接口
├─ 方法: HandleExpiration
└─ 实现: DirectRemoveStrategy, ReduceStackStrategy

BuffStrategyFactory (Strategy/BuffStrategy.cs)
├─ 静态类
└─ 方法: CreateStackStrategy, CreateRefreshStrategy, CreateRemoveStrategy
```

### Level 6: 事件层

```
BuffEventSystem (Events/BuffEventSystem.cs)
├─ 静态类
├─ 字段: eventQueue, isProcessingQueue, genericEventHandlers
├─ 事件: OnBuffAdded, OnBuffRemoved, OnStackChanged, etc.
└─ 方法: TriggerBuffAdded, TriggerBuffRemoved, etc.

BuffLocalEventSystem (Events/BuffEventSystem.cs)
├─ 类
├─ 字段: owner, localEventQueue, isProcessingLocalQueue
├─ 事件: OnBuffAdded, OnBuffRemoved, OnStackChanged, etc.
└─ 方法: TriggerBuffAdded, TriggerBuffRemoved, etc.
```

### Level 7: 运行时层

```
BuffDataStruct (Runtime/BuffDataStruct.cs)
├─ 结构体 (32 bytes)
├─ 字段: InstanceId, DataId, CurrentStack, MaxStack, etc.
└─ 方法: MarkForRemoval, SetActive, Equals

BuffDataWrapper (Runtime/BuffDataWrapper.cs)
├─ 类
├─ 实现: IBuff
├─ 字段: container, index
└─ 方法: 所有 IBuff 接口方法

BuffEntity (Runtime/BuffEntity.cs)
├─ 类
├─ 实现: IBuff
├─ 字段: instanceId, data, owner, source, logic, etc.
├─ 方法: Reset, Cleanup, AddStack, RemoveStack, etc.
└─ 优化: 对象池复用, 分层更新

BuffContainer (Runtime/BuffContainer.cs)
├─ 类
├─ 实现: IBuffContainer
├─ 字段: buffByInstanceId, buffsByDataId, buffsBySource, etc.
├─ 方法: AddBuff, RemoveBuff, GetBuff, HasBuff, etc.
└─ 优化: 多字典索引, 对象池, 组策略

BuffContainerOptimized (Runtime/BuffContainerOptimized.cs)
├─ 类
├─ 实现: IBuffContainer
├─ 字段: buffDataArray, activeIndices, etc.
└─ 优化: 原生数组, 零 GC 访问

BuffContainerNativeArray (Runtime/BuffContainerNativeArray.cs)
├─ 类
├─ 实现: IBuffContainer
├─ 字段: nativeArray, activeIndices, etc.
└─ 优化: NativeArray, Burst 编译

BuffOwner (Runtime/BuffOwner.cs)
├─ MonoBehaviour
├─ 实现: IBuffOwner
├─ 字段: buffContainer, localEvents, immuneBuffIdSet, etc.
├─ 方法: AddBuff, RemoveBuff, HasBuff, etc.
└─ 优化: 免疫系统, 调试信息

BuffSystemUpdater (Runtime/BuffSystemUpdater.cs)
├─ MonoBehaviour
├─ 字段: updateMode, enableFrequencyBasedUpdate, etc.
├─ 方法: UpdateAll, AdvanceTurn, SetUpdateMode, etc.
└─ 优化: 分层更新, 批处理

FrequencyBasedUpdater (Runtime/FrequencyBasedUpdater.cs)
├─ 类
├─ 字段: frequencyBuckets, autoAssignFrequency, etc.
├─ 方法: Update, Register, RegisterAuto, Unregister, etc.
└─ 优化: 分层更新, 自动分配

FrequencyAssigner (Runtime/FrequencyAssigner.cs)
├─ 类
└─ 方法: AssignFrequency, GetOptimalFrequency

BuffSaveManager (Runtime/BuffSaveManager.cs)
├─ 静态类
├─ 方法: SaveAll, SaveOwner, SaveBuff, LoadAll, LoadOwner, LoadBuff
└─ 支持: 版本管理, JSON 序列化

BuffPerformanceMonitor (Runtime/BuffPerformanceMonitor.cs)
├─ 类
├─ 字段: frameTime, gcAlloc, buffCount, etc.
└─ 方法: BeginFrame, EndFrame, RecordBuffOperation, etc.
```

### Level 8: 高级功能层

#### Combo 系统

```
ComboEffectType (Advanced/Combo/ComboEffectType.cs)
└─ 枚举: EnhanceDuration, EnhanceStack, ReduceCooldown, etc.

ComboEffect (Advanced/Combo/ComboEffect.cs)
├─ 结构体
├─ 字段: effectType, targetType, value, etc.
└─ 方法: Validate

BuffComboData (Advanced/Combo/BuffComboData.cs)
├─ ScriptableObject
├─ 字段: comboId, comboName, requiredBuffIds, triggerMode, etc.
├─ 方法: IsValid, CheckCondition, GetMatchedBuffCount
└─ 枚举: ComboTriggerMode

BuffComboEventSystem (Advanced/Combo/BuffComboEventSystem.cs)
├─ 静态类
├─ 事件: OnComboActivated, OnComboDeactivated, etc.
└─ 方法: TriggerComboActivated, TriggerComboDeactivated, etc.

BuffComboManager (Advanced/Combo/BuffComboManager.cs)
├─ MonoBehaviour
├─ 字段: registeredCombos, combosByBuffId, activeCombos, etc.
├─ 方法: RegisterCombo, UnregisterCombo, TryActivateCombo, etc.
└─ 优化: 事件驱动, 优先级排序
```

#### Fusion 系统

```
IBuffFusion (Advanced/Fusion/IBuffFusion.cs)
└─ 接口

FusionConditions (Advanced/Fusion/Conditions/FusionConditions.cs)
├─ 类
└─ 方法: CheckCanFuse, CheckFusionResult

FusionEventSystem (Advanced/Fusion/FusionEventSystem.cs)
├─ 静态类
├─ 事件: OnFusionStarted, OnFusionCompleted, OnFusionProgress
└─ 方法: TriggerFusionStarted, TriggerFusionCompleted, etc.

FusionManager (Advanced/Fusion/FusionManager.cs)
├─ MonoBehaviour
├─ 字段: recipes, activeFusions
├─ 方法: RegisterRecipe, TryFusion, GetAvailableFusions
└─ 优化: 延迟融合, 进度事件
```

#### Transmission 系统

```
IBuffTransmissible (Advanced/Transmission/IBuffTransmissible.cs)
└─ 接口

TransmissionEventSystem (Advanced/Transmission/TransmissionEventSystem.cs)
├─ 静态类
├─ 事件: OnTransmissionStart, OnTransmissionComplete, etc.
└─ 方法: TriggerTransmissionStart, TriggerTransmissionComplete, etc.

TransmissionManager (Advanced/Transmission/TransmissionManager.cs)
├─ MonoBehaviour
├─ 字段: transmissionQueue
├─ 方法: RequestTransmission, ProcessTransmission
└─ 优化: 队列化处理, 每帧限制

ChainTransmission (Advanced/Transmission/Modes/ChainTransmission.cs)
├─ 类
├─ 实现: IBuffTransmissible
└─ 方法: GetTransmissionTargets, CanTransmit, OnTransmit

ContactTransmission (Advanced/Transmission/Modes/ContactTransmission.cs)
├─ 类
├─ 实现: IBuffTransmissible
└─ 方法: GetTransmissionTargets, CanTransmit, OnTransmit
```

#### Snapshot 系统

```
BuffSnapshot (Advanced/Snapshot/BuffSnapshot.cs)
├─ 类
├─ 字段: buffId, ownerId, timestamp, buffData
└─ 方法: Restore

SnapshotHelper (Advanced/Snapshot/SnapshotHelper.cs)
├─ 静态类
└─ 方法: CreateSnapshot, RestoreSnapshot, etc.

BuffSnapshotManager (Advanced/Snapshot/BuffSnapshotManager.cs)
├─ 类
├─ 字段: snapshots
├─ 方法: CreateSnapshot, RestoreSnapshot, ClearSnapshots
└─ 优化: 自动过期, 限制数量
```

#### Area 系统

```
BuffArea (Advanced/Area/BuffArea.cs)
├─ MonoBehaviour
├─ 字段: buffId, areaRadius, applyInterval, etc.
└─ 方法: OnTriggerEnter, OnTriggerExit, Update

BuffAreaManager (Advanced/Area/BuffAreaManager.cs)
├─ MonoBehaviour
├─ 字段: activeAreas
├─ 方法: RegisterArea, UnregisterArea, UpdateAreas
└─ 优化: 空间分区, 批处理
```

### Level 9: 效果层

```
DelayEffect (Effects/Core/DelayEffect.cs)
├─ 类
├─ 继承: EffectBase
├─ 实现: IBuffLogicUpdate
├─ 字段: delay, delayedEffects, timer, hasTriggered
└─ 方法: Execute, OnLogicUpdate, Cancel

PlayAnimationEffect (Effects/Core/PlayAnimationEffect.cs)
├─ 类
├─ 继承: EffectBase
├─ 字段: animationName, animationSpeed, etc.
└─ 方法: Execute, Cancel

PlaySoundEffect (Effects/Core/PlaySoundEffect.cs)
├─ 类
├─ 继承: EffectBase
├─ 字段: soundClip, volume, pitch, etc.
└─ 方法: Execute, Cancel

SpawnEffect (Effects/Core/SpawnEffect.cs)
├─ 类
├─ 继承: EffectBase
├─ 字段: prefab, spawnPosition, spawnCount, etc.
└─ 方法: Execute, Cancel

TriggerEventEffect (Effects/Core/TriggerEventEffect.cs)
├─ 类
├─ 继承: EffectBase
├─ 字段: eventName, eventData
└─ 方法: Execute, Cancel
```

### Level 10: 分组层

```
IBuffGroup (Groups/IBuffGroup.cs)
└─ 接口

BuffGroup (Groups/BuffGroup.cs)
├─ 类
├─ 实现: IBuffGroup
├─ 字段: groupId, maxGroupStack, policy, buffs
├─ 方法: AddToGroup, RemoveFromGroup, Contains, Clear
└─ 策略: AllowAll, BlockNew, ReplaceOldest, ReplaceWeakest
```

### Level 11: 修饰器层

```
IBuffModifier (Modifiers/IBuffModifier.cs)
└─ 接口

BuffModifier (Modifiers/BuffModifier.cs)
├─ 类
├─ 实现: IBuffModifier
├─ 字段: durationMultiplier, stackMultiplier, priority, etc.
├─ 方法: CanModify, OnBeforeApply, OnAfterApply
└─ 子类: DurationModifier, StackModifier, CompositeModifier
```

### Level 12: 网络层

```
IBuffNetworkSync (Networking/IBuffNetworkSync.cs)
└─ 接口

BuffMirrorSync (Networking/Mirror/BuffMirrorSync.cs)
├─ NetworkBehaviour
├─ 实现: IBuffNetworkSync
└─ 方法: SyncBuff, SyncBuffRemoval, etc.

BuffNetcodeSync (Networking/Netcode/BuffNetcodeSync.cs)
├─ NetworkBehaviour
├─ 实现: IBuffNetworkSync
└─ 方法: SyncBuff, SyncBuffRemoval, etc.
```

### Level 13: 流式 API 层

```
BuffBuilder (Fluent/BuffBuilder.cs)
├─ 类
├─ 字段: data, owner, source, modifiers, etc.
├─ 方法: WithData, WithOwner, WithSource, WithModifier, etc.
└─ 方法: Build

BuffBuilderExtensions (Fluent/BuffBuilderExtensions.cs)
├─ 静态类
└─ 方法: WithDuration, WithStack, WithTag, etc.
```

### Level 14: 核心 API 层

```
BuffApi (Core/BuffApi.cs)
├─ 静态类
├─ 方法: Initialize, ReloadData
├─ 方法: AddBuff, RemoveBuff, ClearBuffs
├─ 方法: HasBuff, GetBuff, GetBuffs, GetAllBuffs
├─ 方法: GetBuffData, HasBuffData, GetAllBuffData
└─ 方法: RefreshBuff, AddStack, RemoveStack

BuffSystemManager (Core/BuffSystemManager.cs)
├─ MonoBehaviour
├─ 字段: comboManager, fusionManager, transmissionManager
├─ 属性: Instance, Combo, Fusion, Transmission
└─ 方法: SetComboManager, SetFusionManager, SetTransmissionManager

ApiStabilityAttribute (Core/ApiStabilityAttribute.cs)
└─ Attribute
```

### Level 15: 编辑器层

```
BuffSystemMenu (Editor/BuffSystemMenu.cs)
└─ 静态类

BuffOwnerEditor (Editor/BuffOwnerEditor.cs)
└─ Editor

BuffDataSOEditor (Editor/BuffDataSOEditor.cs)
└─ Editor

BuffConfigValidator (Editor/BuffConfigValidator.cs)
└─ 静态类

BuffSystemDebugger (Editor/BuffSystemDebugger.cs)
└─ EditorWindow

ApiDocumentationGenerator (Editor/ApiDocumentationGenerator.cs)
└─ 静态类

PerformanceTestEditor (Editor/PerformanceTestEditor.cs)
└─ EditorWindow
```

### Level 16: 测试层

```
BuffPerformanceTestBase (Tests/BuffPerformanceTestBase.cs)
└─ 抽象类

BuffSystemPerformanceTests (Tests/BuffSystemPerformanceTests.cs)
└─ 类

ExamplePerformanceTest (Tests/ExamplePerformanceTest.cs)
└─ 类

BenchmarkRunner (Tests/BenchmarkRunner.cs)
└─ 类

PerformanceReportGenerator (Tests/PerformanceReportGenerator.cs)
└─ 类
```

---

## 依赖关系矩阵

### 核心依赖

| 文件 | 依赖文件 | 依赖类型 |
|------|---------|---------|
| BuffEntity | IBuff | 实现 |
| BuffEntity | IBuffData | 使用 |
| BuffEntity | IBuffLogic | 使用 |
| BuffEntity | IBuffOwner | 使用 |
| BuffContainer | IBuff | 使用 |
| BuffContainer | IBuffContainer | 实现 |
| BuffContainer | IBuffOwner | 使用 |
| BuffOwner | IBuffOwner | 实现 |
| BuffOwner | IBuffContainer | 使用 |
| BuffOwner | BuffContainer | 创建 |

### 数据依赖

| 文件 | 依赖文件 | 依赖类型 |
|------|---------|---------|
| BuffDataSO | IBuffData | 实现 |
| BuffDataSO | IBuffCondition | 使用 |
| BuffDatabase | IBuffData | 使用 |
| BuffDatabase | BuffDataSO | 使用 |
| BuffSystemConfig | ScriptableObject | 继承 |

### 运行时依赖

| 文件 | 依赖文件 | 依赖类型 |
|------|---------|---------|
| BuffSystemUpdater | MonoBehaviour | 继承 |
| BuffSystemUpdater | BuffOwner | 使用 |
| BuffSystemUpdater | FrequencyBasedUpdater | 创建 |
| FrequencyBasedUpdater | IBuff | 使用 |
| FrequencyBasedUpdater | UpdateFrequency | 使用 |
| BuffSaveManager | IBuff | 使用 |
| BuffSaveManager | IBuffOwner | 使用 |
| BuffSaveManager | BuffOwner | 使用 |

### 高级功能依赖

| 文件 | 依赖文件 | 依赖类型 |
|------|---------|---------|
| BuffComboManager | MonoBehaviour | 继承 |
| BuffComboManager | BuffComboData | 使用 |
| BuffComboManager | BuffEventSystem | 使用 |
| BuffComboManager | BuffApi | 使用 |
| FusionManager | MonoBehaviour | 继承 |
| FusionManager | BuffDatabase | 使用 |
| FusionManager | BuffEventSystem | 使用 |
| TransmissionManager | MonoBehaviour | 继承 |
| TransmissionManager | BuffEventSystem | 使用 |

---

## 循环依赖检测

**检测结果**: ✅ 无循环依赖

系统架构设计良好，所有依赖关系都是单向的，没有发现循环依赖。

---

## 依赖复杂度分析

### 高复杂度文件

| 文件 | 依赖数 | 复杂度 |
|------|--------|--------|
| BuffContainer.cs | 8 | 高 |
| BuffOwner.cs | 7 | 高 |
| BuffEntity.cs | 6 | 中 |
| BuffApi.cs | 6 | 中 |
| BuffComboManager.cs | 5 | 中 |
| FusionManager.cs | 4 | 中 |
| TransmissionManager.cs | 4 | 中 |

### 低复杂度文件

| 文件 | 依赖数 | 复杂度 |
|------|--------|--------|
| BuffEventType.cs | 0 | 低 |
| BuffTag.cs | 0 | 低 |
| BuffTagManager.cs | 0 | 低 |
| UpdateFrequency.cs | 0 | 低 |
| UpdateMode.cs | 0 | 低 |

---

**依赖图谱生成完成时间**: 2026-02-13
